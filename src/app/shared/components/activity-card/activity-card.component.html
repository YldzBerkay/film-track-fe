<article class="activity-card">
    <div class="activity-header">
        <div class="activity-user">
            <div class="user-avatar-small"
                [style.background-image]="'url(' + (activity.userId.avatar || 'assets/default-avatar.png') + ')'">
            </div>
            <div class="activity-meta">
                <p class="activity-text">
                    <a [routerLink]="profileLink" (click)="$event.stopPropagation()" class="user-name">{{
                        activity.userId.name || activity.userId.username }}</a>
                    <span class="user-title" *ngIf="activity.userId.mastery?.title">
                        â€¢ {{ 'masterRank.' + activity.userId.mastery?.title | translate }}
                    </span>
                    @if (activity.type === 'movie_watched') {
                    {{ 'activity.watched' | translate }}
                    } @else if (activity.type === 'tv_episode_watched') {
                    {{ 'activity.watchedEpisode' | translate }}
                    } @else if (activity.type === 'tv_show_watched') {
                    {{ 'activity.watched' | translate }}
                    } @else if (activity.type === 'bulk_import') {
                    {{ 'activity.importedHistory' | translate }}
                    }
                </p>
                <div class="activity-time-row">
                    <p class="activity-time">{{ getTimeAgo(activity.createdAt) }}</p>
                    @if (activity.isMoodPick) {
                    <span class="mood-pick-badge" title="You liked this from your Mood Recommendations">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        <span class="mood-text">{{ 'activity.moodPick' | translate }}</span>
                    </span>
                    }
                </div>
            </div>
        </div>
        @if (activity.rating) {
        <div class="activity-rating-badge">
            <span class="material-symbols-outlined">star</span>
            <span>{{ activity.rating }}/10</span>
        </div>
        }
    </div>

    <div class="activity-content">
        @if (activity.type === 'tv_episode_watched' && activity.episodeNumber) {
        <div class="episodes-grid">
            <div class="episode-card">
                <div class="episode-poster"
                    [style.background-image]="'url(' + tmdbService.getPosterUrl(activity.mediaPosterPath) + ')'"></div>
                <p class="episode-title">
                    S{{ activity.seasonNumber }}:E{{ activity.episodeNumber }}
                    @if (activity.episodeTitle) {
                    "{{ activity.episodeTitle }}"
                    }
                </p>
                @if (activity.rating) {
                <div class="episode-rating-badge">
                    <span class="material-symbols-outlined" style="font-size: 16px;">star</span>
                    <span>{{ activity.rating }}/10</span>
                </div>
                }
            </div>
        </div>
        } @else if (activity.type === 'bulk_import') {
        <!-- Bulk import: show only title, no poster or year -->
        <div class="media-content bulk-import-content">
            <div class="media-info">
                <h3 class="media-title">
                    <a [routerLink]="mediaLink" (click)="$event.stopPropagation()">{{ activity.mediaTitle }}</a>
                </h3>
            </div>
        </div>
        } @else {
        <div class="media-content">
            <div class="media-poster"
                [style.background-image]="'url(' + tmdbService.getPosterUrl(activity.mediaPosterPath) + ')'"
                [routerLink]="mediaLink" (click)="$event.stopPropagation()"></div>
            <div class="media-info">
                <h3 class="media-title">
                    <a [routerLink]="mediaLink" (click)="$event.stopPropagation()">
                        {{ activity.mediaTitle }}
                    </a>
                    @if (activity.mediaType === 'movie' && activity.createdAt) {
                    <span class="media-year">({{ getYear(activity.createdAt) }})</span>
                    }
                </h3>
                @if (activity.reviewText) {
                <p class="media-review">{{ activity.reviewText }}</p>
                }
                @if (activity.genres && activity.genres.length > 0) {
                <div class="media-genres">
                    @for (genre of activity.genres; track genre) {
                    <span class="genre-tag">{{ genre }}</span>
                    }
                </div>
                }
            </div>
        </div>
        }
    </div>

    <div class="activity-actions">
        <app-reaction-bar [targetId]="activity._id" [targetType]="'activity'"
            [likesCount]="activity.likesCount || (activity.likes || []).length"
            [dislikesCount]="activity.dislikesCount || 0" [userVote]="getUserVote()">
        </app-reaction-bar>
        <button class="action-btn" (click)="toggleComments()">
            <span class="material-symbols-outlined">chat_bubble</span>
            <span>{{ activity.commentCount || 0 }}</span>
        </button>
        <button class="action-btn bookmark-btn" [class.active]="isBookmarked" (click)="onBookmarkClick($event)"
            [title]="isBookmarked ? ('bookmarks.remove' | translate) : ('bookmarks.subtitle' | translate)">
            <span class="material-symbols-outlined">{{ isBookmarked ? 'bookmark' :
                'bookmark_border' }}</span>
        </button>
        <!-- Taste Match Button (only for other users) -->
        @if (currentUser && activity.userId._id !== currentUser.id) {
        <button class="action-btn taste-match-btn" (click)="onTasteMatchClick($event)"
            [title]="'dashboard.ourTaste' | translate">
            <span class="material-symbols-outlined">diversity_1</span>
        </button>
        }
    </div>

    <!-- Comments Section -->
    @if (isCommentsExpanded()) {
    <div class="comments-section">
        <app-comment-list [activityId]="activity._id" [initialCount]="activity.commentCount || 0"
            (commentAdded)="onCommentAdded()">
        </app-comment-list>
    </div>
    }
</article>