@if (isLoading()) {
<div class="loading-container">
  <div class="loading">{{ 'details.loadingTv' | translate }}</div>
</div>
} @else if (error()) {
<div class="error-container">
  <div class="error-message">{{ error() }}</div>
  <button class="back-btn" (click)="router.navigate(['/'])" type="button">{{ 'details.goBack' | translate }}</button>
</div>
} @else if (tvShow()) {
@let showData = tvShow()!;
<div class="tv-show-detail-container">
  <!-- Hero Section with Backdrop -->
  <div class="hero-section"
    [style.background-image]="'url(' + tmdbService.getBackdropUrl(showData.backdrop_path) + ')'">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <button class="back-button" (click)="router.navigate(['/dashboard'])" type="button">
        <span class="material-symbols-outlined">arrow_back</span>
        {{ 'details.back' | translate }}
      </button>
      <div class="hero-info">
        <div class="hero-poster">
          <img [src]="tmdbService.getPosterUrl(showData.poster_path, 'w500')" [alt]="showData.name"
            class="poster-image" />
        </div>
        <div class="hero-details">
          <h1 class="show-title">
            {{ showData.name }}
            @if (showData.first_air_date) {
            <span class="show-year">({{ formatDate(showData.first_air_date) }})</span>
            }
          </h1>
          <div class="show-meta">
            @if (showData.first_air_date) {
            <span class="meta-item">{{ formatDate(showData.first_air_date) }}</span>
            }
            @if (showData.number_of_seasons) {
            <span class="meta-separator">•</span>
            <span class="meta-item">{{ 'details.seasonsCount' | translate:{count: showData.number_of_seasons} }}</span>
            }
            @if (showData.number_of_episodes) {
            <span class="meta-separator">•</span>
            <span class="meta-item">{{ 'details.episodesCount' | translate:{count: showData.number_of_episodes}
              }}</span>
            }
            @if (showData.genres && showData.genres.length > 0) {
            <span class="meta-separator">•</span>
            <span class="meta-item">{{ showData.genres[0].name }}</span>
            }
          </div>
          <div class="rating-section internal-rating" data-tooltip="CineTrack Rating">
            <span class="rating-label">CineTrack</span>
            <div class="rating-content">
              <span class="rating-value">{{ (publicStats()?.count || 0) > 0 ? publicStats()?.averageRating?.toFixed(1) :
                '?'
                }}</span>
              <span class="rating-count">({{ publicStats()?.count || 0 }} {{ 'details.votes' | translate }})</span>
            </div>
          </div>
          @if (showData.vote_average) {
          <div class="rating-section tmdb-rating" data-tooltip="TMDB Rating">
            <span class="rating-label">TMDB</span>
            <div class="rating-content">
              <span class="rating-value">{{ showData.vote_average.toFixed(1) }}</span>
              @if (showData.vote_count) {
              <span class="rating-count">({{ showData.vote_count | number }} {{ 'details.votes' | translate }})</span>
              }
            </div>
          </div>
          }

          <div class="action-buttons">
            <button [class]="isWatched() ? 'btn-secondary' : 'btn-primary'" (click)="toggleWatched()"
              [disabled]="isLogging()">
              <span class="material-symbols-outlined">{{ isWatched() ? 'done' : 'add' }}</span>
              {{ isWatched() ? ('details.watched' | translate) : ('details.log' | translate) }}
            </button>
            <button class="btn-secondary" [class.rated]="userRating()" (click)="openRateDialog()">
              <span class="material-symbols-outlined">{{ userRating() ? 'star' : 'star_rate' }}</span>
              {{ userRating() ? ('details.rated' | translate:{rating: userRating()!}) : ('details.rate' | translate) }}
            </button>
            <button class="btn-icon" (click)="onAddToList()">
              <span class="material-symbols-outlined">bookmark_add</span>
            </button>
            <button class="btn-icon">
              <span class="material-symbols-outlined">share</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="content-grid">
      <!-- Left Column -->
      <div class="content-main">
        <!-- Overview -->
        @if (showData.overview) {
        <section class="section">
          <h2 class="section-title">{{ 'details.overview' | translate }}</h2>
          <p class="overview-text">{{ showData.overview }}</p>
        </section>
        }

        <!-- Seasons Accordion -->
        @if (showData.seasons && showData.seasons.length > 0) {
        <section class="section">
          <h2 class="section-title">{{ 'details.seasons' | translate }}</h2>
          <div class="seasons-accordion">
            @for (season of showData.seasons; track season.id) {
            <div class="accordion-item" [class.active]="selectedSeason() === season.season_number">
              <button class="accordion-header" (click)="onSeasonSelect(season.season_number)" type="button">
                <div class="header-left">
                  <span class="season-number">S{{ season.season_number }}</span>
                  @if (season.name) {
                  <span class="season-name">{{ season.name }}</span>
                  }
                </div>
                <div class="header-right">
                  @if (season.vote_average) {
                  <span class="season-rating tmdb" data-tooltip="TMDB Rating">
                    <span class="material-symbols-outlined">star</span>
                    {{ season.vote_average.toFixed(1) }}
                  </span>
                  }
                  @if (season.season_number !== 0) {
                  <span class="season-rating ct" data-tooltip="CineTrack Rating">
                    <span class="material-symbols-outlined">star</span>
                    {{ seasonPublicStats()[season.season_number]?.count ?
                    seasonPublicStats()[season.season_number].averageRating : '?' }}
                    <span class="vote-count">({{ seasonPublicStats()[season.season_number]?.count || 0 }})</span>
                  </span>
                  <button class="season-rate-btn" [class.rated]="seasonRatings()[season.season_number]"
                    (click)="openSeasonRateDialog(season, $event)" type="button">
                    <span class="material-symbols-outlined">{{ seasonRatings()[season.season_number] ? 'star' :
                      'star_rate' }}</span>
                    @if (seasonRatings()[season.season_number]) {
                    <span>{{ seasonRatings()[season.season_number] }}/10</span>
                    } @else {
                    <span>{{ 'details.rate' | translate }}</span>
                    }
                  </button>
                  }
                  <span class="season-episodes">{{ 'details.seasonEpisodes' | translate:{count: season.episode_count}
                    }}</span>
                  <span class="material-symbols-outlined expand-icon">{{ selectedSeason() === season.season_number ?
                    'expand_less' : 'expand_more' }}</span>
                </div>
              </button>

              @if (selectedSeason() === season.season_number) {
              <div class="accordion-panel">
                @if (isSeasonLoading()) {
                <div class="season-loading">
                  <div class="spinner"></div>
                </div>
                } @else if (seasonDetails()) {
                <div class="episodes-list">
                  @for (episode of seasonDetails()!.episodes; track episode.id) {
                  <div class="episode-card">
                    <div class="episode-still">
                      @if (episode.still_path) {
                      <img [src]="tmdbService.getPosterUrl(episode.still_path, 'w300')" [alt]="episode.name" />
                      } @else {
                      <div class="still-placeholder">
                        <span class="material-symbols-outlined">movie</span>
                      </div>
                      }
                      <div class="episode-number">E{{ episode.episode_number }}</div>
                    </div>
                    <div class="episode-info">
                      <div class="episode-header">
                        <h4 class="episode-name">{{ episode.name }}</h4>
                        <span class="episode-air-date">{{ episode.air_date | date:'mediumDate' }}</span>
                      </div>
                      @if (episode.overview) {
                      <p class="episode-overview">{{ episode.overview }}</p>
                      }
                      <div class="episode-meta">
                        @if (episode.vote_average) {
                        <span class="episode-rating tmdb">
                          <span class="material-symbols-outlined">star</span>
                          {{ episode.vote_average.toFixed(1) }}
                        </span>
                        }

                        <span class="episode-rating ct" [title]="'CineTrack Rating'">
                          <span class="material-symbols-outlined">star</span>
                          {{ episodePublicStats()[episode.episode_number]?.count ?
                          episodePublicStats()[episode.episode_number].averageRating : '?' }}
                          <span class="vote-count">({{ episodePublicStats()[episode.episode_number]?.count || 0
                            }})</span>
                        </span>

                        <button class="episode-rate-btn" [class.rated]="episodeRatings()[episode.episode_number]"
                          (click)="openEpisodeRateDialog(episode)" type="button">
                          <span class="material-symbols-outlined">{{ episodeRatings()[episode.episode_number] ? 'star' :
                            'star_rate' }}</span>
                          @if (episodeRatings()[episode.episode_number]) {
                          <span>{{ episodeRatings()[episode.episode_number] }}/10</span>
                          } @else {
                          <span>{{ 'details.rate' | translate }}</span>
                          }
                        </button>
                      </div>
                    </div>
                  </div>
                  }
                </div>
                }
              </div>
              }
            </div>
            }
          </div>
        </section>
        }

        <!-- Cast -->
        @if (showData.credits && showData.credits.cast && showData.credits.cast.length > 0) {
        <section class="section">
          <h2 class="section-title">{{ 'details.cast' | translate }}</h2>
          <div class="cast-grid">
            @for (actor of showData.credits.cast.slice(0, 12); track actor.id) {
            <div class="cast-item">
              <div class="cast-image">
                @if (actor.profile_path) {
                <img [src]="tmdbService.getPosterUrl(actor.profile_path, 'w185')" [alt]="actor.name" />
                } @else {
                <div class="cast-placeholder">
                  <span class="material-symbols-outlined">person</span>
                </div>
                }
              </div>
              <div class="cast-info">
                <p class="cast-name">{{ actor.name }}</p>
                <p class="cast-character">{{ actor.character }}</p>
              </div>
            </div>
            }
          </div>
        </section>
        }
      </div>

      <!-- Right Sidebar -->
      <aside class="sidebar">
        <!-- Info Box -->
        <div class="info-box">
          <h3 class="info-title">{{ 'details.showInfo' | translate }}</h3>
          <div class="info-list">
            @if (showData.first_air_date) {
            <div class="info-item">
              <span class="info-label">{{ 'details.firstAirDate' | translate }}</span>
              <span class="info-value">{{ showData.first_air_date | date: 'longDate' }}</span>
            </div>
            }
            @if (showData.number_of_seasons) {
            <div class="info-item">
              <span class="info-label">{{ 'details.seasons' | translate }}</span>
              <span class="info-value">{{ showData.number_of_seasons }}</span>
            </div>
            }
            @if (showData.number_of_episodes) {
            <div class="info-item">
              <span class="info-label">{{ 'details.episodes' | translate }}</span>
              <span class="info-value">{{ showData.number_of_episodes }}</span>
            </div>
            }
            @if (showData.status) {
            <div class="info-item">
              <span class="info-label">{{ 'details.status' | translate }}</span>
              <span class="info-value">{{ showData.status }}</span>
            </div>
            }
          </div>
        </div>

        <!-- Genres -->
        @if (showData.genres && showData.genres.length > 0) {
        <div class="info-box">
          <h3 class="info-title">{{ 'details.genres' | translate }}</h3>
          <div class="genres-list">
            @for (genre of showData.genres; track genre.id) {
            <span class="genre-tag">{{ genre.name }}</span>
            }
          </div>
        </div>
        }

        <!-- Production Companies -->
        @if (showData.production_companies && showData.production_companies.length > 0) {
        <div class="info-box">
          <h3 class="info-title">{{ 'details.production' | translate }}</h3>
          <div class="production-list">
            @for (company of showData.production_companies; track company.id) {
            <div class="production-item">
              @if (company.logo_path) {
              <img [src]="tmdbService.getPosterUrl(company.logo_path, 'w92')" [alt]="company.name"
                class="production-logo" />
              } @else {
              <span class="production-name">{{ company.name }}</span>
              }
            </div>
            }
          </div>
        </div>
        }

        <!-- Crew -->
        @if (showData.credits && showData.credits.crew && showData.credits.crew.length > 0) {
        <div class="info-box">
          <h3 class="info-title">{{ 'details.crew' | translate }}</h3>
          <div class="crew-list">
            @for (member of showData.credits.crew.slice(0, 5); track $index) {
            <div class="crew-item">
              <span class="crew-name">{{ member.name }}</span>
              <span class="crew-job">{{ member.job }}</span>
            </div>
            }
          </div>
        </div>
        }
      </aside>
    </div>
  </div>
</div>

@if (tvShow()) {
<app-add-to-list-dialog [isOpen]="isAddToListOpen()" [tmdbId]="tvShow()!.id" mediaType="tv" [title]="tvShow()!.name"
  [posterPath]="tvShow()!.poster_path || undefined" [runtime]="calculateTotalRuntime(tvShow()!, false)"
  [releaseDate]="tvShow()!.first_air_date || undefined" [numberOfEpisodes]="tvShow()!.number_of_episodes"
  [numberOfSeasons]="tvShow()!.number_of_seasons" [hasSpecials]="hasSpecials()"
  [specialsEpisodeCount]="specialsEpisodeCount()" (close)="closeAddToList()"></app-add-to-list-dialog>

<app-rate-dialog [isOpen]="isRateDialogOpen()" [title]="tvShow()!.name" [initialRating]="userRating()"
  (close)="closeRateDialog()" (save)="onRate($event)">
</app-rate-dialog>

@if (ratingEpisode()) {
<app-rate-dialog [isOpen]="episodeRatingDialogOpen()" [title]="ratingEpisode()!.name"
  [initialRating]="episodeRatings()[ratingEpisode()!.episodeNumber] || null" (close)="closeEpisodeRateDialog()"
  (save)="onRateEpisode($event)">
</app-rate-dialog>
}

@if (ratingSeason()) {
<app-rate-dialog [isOpen]="seasonRatingDialogOpen()" [title]="ratingSeason()!.name"
  [initialRating]="seasonRatings()[ratingSeason()!.seasonNumber] || null" (close)="closeSeasonRateDialog()"
  (save)="onRateSeason($event)">
</app-rate-dialog>
}

<app-dialog [isOpen]="isSpecialsDialogOpen()" [title]="'watched.includeSpecials' | translate"
  [message]="'watched.includeSpecialsMessage' | translate" [confirmText]="'watched.yesInclude' | translate"
  [cancelText]="'watched.noExclude' | translate" type="warning" (confirm)="onSpecialsConfirm(true)"
  (cancel)="onSpecialsConfirm(false)" (close)="isSpecialsDialogOpen.set(false)">
</app-dialog>
}
}