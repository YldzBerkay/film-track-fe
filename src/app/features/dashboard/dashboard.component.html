<div class="dashboard-container">
  <!-- Floating Ambient Orbs -->
  <div class="floating-orb floating-orb--primary"></div>
  <div class="floating-orb floating-orb--accent"></div>
  <div class="floating-orb floating-orb--secondary"></div>

  <app-header (logClick)="onLogClick()"></app-header>

  <main class="main-content">
    <div class="dashboard-grid">
      <aside class="sidebar">

        <nav class="sidebar-nav">
          <a class="nav-item active" routerLink="/dashboard">
            <span class="material-symbols-outlined">home</span>
            {{ 'nav.home' | translate }}
          </a>
          <a class="nav-item" routerLink="/movies">
            <span class="material-symbols-outlined">movie</span>
            {{ 'nav.films' | translate }}
          </a>
          <a class="nav-item" routerLink="/tv-shows">
            <span class="material-symbols-outlined">tv</span>
            {{ 'nav.tvShows' | translate }}
          </a>
          <a class="nav-item" routerLink="/lists">
            <span class="material-symbols-outlined">list</span>
            {{ 'nav.lists' | translate }}
          </a>
          <a class="nav-item" routerLink="/journal">
            <span class="material-symbols-outlined">edit_note</span>
            {{ 'nav.journal' | translate }}
          </a>
          <a class="nav-item" routerLink="/profile">
            <span class="material-symbols-outlined">person</span>
            {{ 'nav.myProfile' | translate }}
          </a>
        </nav>

        <div class="lists-section">
          <div class="lists-header">
            <h3 class="lists-title">My Lists</h3>
            <button class="lists-add-btn">
              <span class="material-symbols-outlined">add</span>
            </button>
          </div>
          <div class="lists-items">
            <a class="list-item" href="#">
              <div class="list-cover"></div>
              <div class="list-info">
                <p class="list-name">Watchlist</p>
                <p class="list-count">0 films</p>
              </div>
            </a>
          </div>
        </div>
      </aside>

      <div class="feed-section">
        <div class="feed-tabs">
          <button class="feed-tab" [class.active]="activeFeedType() === 'following'"
            (click)="onFeedTypeChange('following')">
            {{ 'dashboard.followingTab' | translate }}
          </button>
          <button class="feed-tab" [class.active]="activeFeedType() === 'friends'"
            (click)="onFeedTypeChange('friends')">
            {{ 'dashboard.friendsTab' | translate }}
          </button>
          <button class="feed-tab" [class.active]="activeFeedType() === 'global'" (click)="onFeedTypeChange('global')">
            {{ 'dashboard.globalTab' | translate }}
          </button>
        </div>

        <div class="feed-content">
          @if (isLoading() && activities().length === 0) {
          <div class="loading">{{ 'dashboard.loadingFeed' | translate }}</div>
          } @else if (activities().length === 0) {
          <div class="empty-state">
            <p>{{ 'dashboard.noActivities' | translate }}</p>
          </div>
          } @else {
          @for (activity of activities(); track activity._id) {
          <article class="activity-card">
            <div class="activity-header">
              <div class="activity-user">
                <div class="user-avatar-small"></div>
                <div class="activity-meta">
                  <p class="activity-text">
                    <span class="user-name">{{ activity.userId.name || activity.userId.username }}</span>
                    @if (activity.type === 'movie_watched') {
                    watched
                    } @else if (activity.type === 'tv_episode_watched') {
                    watched episode
                    } @else if (activity.type === 'tv_show_watched') {
                    watched
                    }
                  </p>
                  <p class="activity-time">{{ getTimeAgo(activity.createdAt) }}</p>
                </div>
              </div>
              @if (activity.rating) {
              <div class="activity-rating">
                @for (star of getStars(activity.rating); track $index) {
                @if (star === 1) {
                <span class="material-symbols-outlined star-filled">star</span>
                } @else if (star === 0.5) {
                <span class="material-symbols-outlined star-half">star_half</span>
                } @else {
                <span class="material-symbols-outlined star-empty">star</span>
                }
                }
              </div>
              }
            </div>

            <div class="activity-content">
              @if (activity.type === 'tv_episode_watched' && activity.episodeNumber) {
              <div class="episodes-grid">
                <div class="episode-card">
                  <div class="episode-poster"
                    [style.background-image]="'url(' + tmdbService.getPosterUrl(activity.mediaPosterPath) + ')'"></div>
                  <p class="episode-title">
                    S{{ activity.seasonNumber }}:E{{ activity.episodeNumber }}
                    @if (activity.episodeTitle) {
                    "{{ activity.episodeTitle }}"
                    }
                  </p>
                  @if (activity.rating) {
                  <div class="episode-rating">
                    @for (star of getStars(activity.rating); track $index) {
                    @if (star === 1) {
                    <span class="material-symbols-outlined star-filled">star</span>
                    } @else if (star === 0.5) {
                    <span class="material-symbols-outlined star-half">star_half</span>
                    } @else {
                    <span class="material-symbols-outlined star-empty">star</span>
                    }
                    }
                  </div>
                  }
                </div>
              </div>
              } @else {
              <div class="media-content">
                <div class="media-poster"
                  [style.background-image]="'url(' + tmdbService.getPosterUrl(activity.mediaPosterPath) + ')'"></div>
                <div class="media-info">
                  <h3 class="media-title">
                    {{ activity.mediaTitle }}
                    @if (activity.mediaType === 'movie' && activity.createdAt) {
                    <span class="media-year">({{ getYear(activity.createdAt) }})</span>
                    }
                  </h3>
                  @if (activity.reviewText) {
                  <p class="media-review">{{ activity.reviewText }}</p>
                  }
                  @if (activity.genres && activity.genres.length > 0) {
                  <div class="media-genres">
                    @for (genre of activity.genres; track genre) {
                    <span class="genre-tag">{{ genre }}</span>
                    }
                  </div>
                  }
                </div>
              </div>
              }
            </div>

            <div class="activity-actions">
              <button class="action-btn">
                <span class="material-symbols-outlined">favorite</span>
                <span>0</span>
              </button>
              <button class="action-btn">
                <span class="material-symbols-outlined">chat_bubble</span>
                <span>0 comments</span>
              </button>
              <button class="action-btn bookmark-btn">
                <span class="material-symbols-outlined">bookmark_add</span>
              </button>
            </div>
          </article>
          }
          }

          @if (hasMore() && !isLoading()) {
          <button class="load-more-btn" (click)="loadMore()">
            Load more
          </button>
          }
        </div>
      </div>

      <aside class="right-sidebar">
        <div class="recommendations-section">
          <div class="section-header">
            <span class="material-symbols-outlined section-icon">auto_awesome</span>
            <h3 class="section-title">{{ 'dashboard.forYou' | translate }}</h3>
          </div>
          @if (isDailyPickLoading()) {
          <div class="daily-pick-card skeleton-card">
            <div class="daily-pick-content">
              <div class="skeleton-badge"></div>
              <div class="skeleton-text title"></div>
              <div class="skeleton-text meta"></div>
              <div class="daily-pick-actions">
                <div class="skeleton-btn"></div>
                <div class="skeleton-btn small"></div>
              </div>
            </div>
          </div>
          } @else if (dailyPick(); as pick) {
          <div class="daily-pick-card">
            <div class="daily-pick-content">
              <div class="daily-pick-header">
                <div class="daily-pick-badge">{{ 'dashboard.dailyPick' | translate }}</div>
                <div class="streak-badge" *ngIf="user()?.streak">
                  <span class="material-symbols-outlined fire-icon">local_fire_department</span>
                  <span>{{ user()?.streak }}</span>
                </div>
              </div>
              <h4 class="daily-pick-title" [title]="pick.title">{{ pick.title }}</h4>
              <div class="daily-pick-meta" [title]="pick.year + ' • ' + pick.genre">
                <span>{{ pick.year }}</span>
                <span class="separator">•</span>
                <span>{{ pick.genre }}</span>
              </div>
              <div class="daily-pick-actions">
                <button class="daily-pick-btn primary">
                  <span class="material-symbols-outlined">play_arrow</span>
                  {{ 'dashboard.watch' | translate }}
                </button>
                <button class="daily-pick-btn secondary" [class.watched]="pick.watched" (click)="openMemoryDialog()"
                  [disabled]="pick.watched">
                  <span class="material-symbols-outlined">{{ pick.watched ? 'done' : 'add' }}</span>
                </button>
              </div>
            </div>
            <div class="daily-pick-backdrop" [style.background-image]="'url(' + pick.backdropUrl + ')'"></div>
          </div>
          }

          @if (isMealtimePickLoading()) {
          <div class="daily-pick-card skeleton-card" style="margin-top: 16px;">
            <div class="daily-pick-content">
              <div class="skeleton-badge"></div>
              <div class="skeleton-text title"></div>
              <div class="skeleton-text meta"></div>
              <div class="daily-pick-actions">
                <div class="skeleton-btn"></div>
                <div class="skeleton-btn small"></div>
              </div>
            </div>
          </div>
          } @else if (mealtimePick(); as meal) {
          <div class="daily-pick-card mealtime-card" style="margin-top: 16px;">
            <div class="daily-pick-content">
              <div class="daily-pick-header">
                <div class="daily-pick-badge mealtime-badge">{{ 'dashboard.mealtimeRoulette' | translate }}</div>
              </div>
              <h4 class="daily-pick-title" [title]="meal.showTitle">{{ meal.showTitle }}</h4>
              <div class="daily-pick-meta" [title]="meal.episodeTitle">
                <span>{{ meal.episodeTitle }}</span>
              </div>
              <div class="daily-pick-meta"
                [title]="'S' + meal.seasonNumber + ' E' + meal.episodeNumber + ' • ' + (meal.runtime | number:'1.0-0') + 'm'">
                <span>S{{ meal.seasonNumber }} E{{ meal.episodeNumber }}</span>
                <span class="separator">•</span>
                <span>{{ meal.runtime | number:'1.0-0' }}m</span>
              </div>
              <div class="daily-pick-actions">
                <button class="daily-pick-btn primary">
                  <span class="material-symbols-outlined">play_arrow</span>
                  {{ 'dashboard.watch' | translate }}
                </button>
                <button class="daily-pick-btn secondary" (click)="loadMealtimePick()">
                  <span class="material-symbols-outlined">refresh</span>
                </button>
                <button class="daily-pick-btn secondary" (click)="openFriendDialog()">
                  <span class="material-symbols-outlined">group</span>
                </button>
              </div>
            </div>
            <div class="daily-pick-backdrop"
              [style.background-image]="'url(' + (meal.stillPath || meal.showPoster) + ')'"></div>
          </div>
          }
        </div>

        <!-- Mood-Based Recommendations -->
        <section class="mood-recs-section">
          <div class="section-header clickable-header" (click)="router.navigate(['/profile'])" style="cursor: pointer;">
            <h3 class="section-title">
              <span class="material-symbols-outlined section-icon">movie_filter</span>
              {{ 'dashboard.forYourMood' | translate }}
              <span class="material-symbols-outlined arrow-icon" style="font-size: 18px;">arrow_forward</span>
            </h3>
          </div>

          @if (isMoodRecsLoading()) {
          <div class="mood-recs-loading">
            <div class="spinner-small"></div>
          </div>
          } @else if (moodRecommendations().length > 0) {
          <div class="mood-recs-grid single-item">
            @for (rec of moodRecommendations().slice(0, 1); track rec.tmdbId) {
            <div class="daily-pick-card" style="margin-bottom: 0;">
              <div class="daily-pick-content">
                <div class="daily-pick-header">
                  <div class="daily-pick-badge"
                    style="background: rgba(108, 92, 231, 0.2); border-color: rgba(108, 92, 231, 0.3); color: #a29bfe;">
                    Mood Match: {{ rec.score }}%
                  </div>
                </div>
                <h4 class="daily-pick-title">{{ rec.title }}</h4>
                <div class="daily-pick-meta">
                  <span>{{ rec.releaseDate | date:'yyyy' }}</span>
                  <span class="separator">•</span>
                  <span class="mood-badge" style="color: #a29bfe;">{{ rec.moodMatchType | titlecase }}</span>
                </div>
                <div class="daily-pick-actions">
                  <a class="daily-pick-btn primary" [routerLink]="['/movie', rec.tmdbId]"
                    style="text-decoration: none; display: flex; align-items: center; justify-content: center;">
                    <span class="material-symbols-outlined">play_arrow</span>
                    {{ 'dashboard.watch' | translate }}
                  </a>
                </div>
              </div>
              <div class="daily-pick-backdrop"
                [style.background-image]="'url(' + getPosterUrl(rec.backdropPath || rec.posterPath) + ')'"></div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state">
            <p>{{ 'dashboard.logMovies' | translate }}</p>
          </div>
          }
        </section>

        <div class="trending-section">
          <div class="section-header">
            <span class="material-symbols-outlined section-icon">trending_up</span>
            <h3 class="section-title">{{ 'dashboard.trendingNow' | translate }}</h3>
          </div>
          <div class="trending-card">
            <div class="trending-tags">
              <a class="trending-tag" href="#">#Barbenheimer</a>
              <a class="trending-tag" href="#">#HorrorSeason</a>
              <a class="trending-tag" href="#">#A24</a>
              <a class="trending-tag" href="#">#SuccessionFinale</a>
              <a class="trending-tag" href="#">#Cannes2024</a>
            </div>
          </div>
        </div>

        <div class="footer-links">
          <a class="footer-link" href="#">About</a>
          <a class="footer-link" href="#">News</a>
          <a class="footer-link" href="#">Pro</a>
          <a class="footer-link" href="#">Apps</a>
          <a class="footer-link" href="#">Podcast</a>
          <span class="footer-copyright">© CineTrack 2024</span>
        </div>
      </aside>
    </div>
  </main>
</div>

<app-dialog [isOpen]="showMemoryDialog()" [title]="'dashboard.memoryTitle' | translate"
  [message]="'dashboard.memoryMessage' | translate" [showInput]="true" [inputMinLength]="25"
  [inputPlaceholder]="'dashboard.memoryPlaceholder' | translate" [confirmText]="'dashboard.verifyMemory' | translate"
  [isLoading]="isDialogLoading()" [resultData]="dialogResult()" (confirm)="handleMemorySubmit($event)"
  (cancel)="closeMemoryDialog()" (close)="closeMemoryDialog()">
</app-dialog>

<!-- Friend Mealtime Dialog -->
<div class="friend-dialog-backdrop" *ngIf="showFriendDialog()" (click)="closeFriendDialog()">
  <div class="friend-dialog" (click)="$event.stopPropagation()">
    <div class="friend-dialog-header">
      <h3>{{ 'dashboard.watchWithFriends' | translate }}</h3>
      <button class="close-btn" (click)="closeFriendDialog()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="friend-dialog-body">
      <!-- Loading State -->
      @if (isFriendPickLoading()) {
      <div class="friend-loading">
        <div class="spinner"></div>
        <p>{{ 'dashboard.findingEpisode' | translate }}</p>
      </div>
      } @else if (friendPickResult(); as result) {
      <!-- Result State -->
      <div class="friend-result">
        <div class="friend-result-poster"
          [style.background-image]="'url(' + (result.stillPath || result.showPoster) + ')'"></div>
        <div class="friend-result-info">
          <h4>{{ result.showTitle }}</h4>
          <p class="episode-info">S{{ result.seasonNumber }} E{{ result.episodeNumber }} - {{ result.episodeTitle }}</p>
          <p class="runtime">{{ result.runtime }}m</p>
          <p class="shared-with" *ngIf="result.sharedWith.length > 0">
            {{ 'dashboard.sharedInterestWith' | translate:{ names: result.sharedWith.join(', ') } }}
          </p>
        </div>
        <div class="friend-result-actions">
          <button class="btn-primary">{{ 'dashboard.watchNow' | translate }}</button>
          <button class="btn-secondary" (click)="friendPickResult.set(null)">{{ 'dashboard.pickAnother' | translate
            }}</button>
        </div>
      </div>
      } @else {
      <!-- Friend Selection State -->
      @if (isFriendsLoading()) {
      <div class="friend-loading">
        <div class="spinner"></div>
        <p>{{ 'dashboard.loadingFriends' | translate }}</p>
      </div>
      } @else if (friendsList().length === 0) {
      <div class="no-friends">
        <span class="material-symbols-outlined">group_off</span>
        <p>{{ 'dashboard.noFriends' | translate }}</p>
        <p class="hint">{{ 'dashboard.noFriendsHint' | translate }}</p>
      </div>
      } @else {
      <p class="select-hint">{{ 'dashboard.selectFriendsHint' | translate }}</p>
      <div class="friend-list">
        @for (friend of friendsList(); track friend.id) {
        <div class="friend-item" [class.selected]="isFriendSelected(friend.id)"
          (click)="toggleFriendSelection(friend.id)">
          <div class="friend-avatar"></div>
          <div class="friend-info">
            <span class="friend-nickname">{{ friend.name || friend.username }}</span>
            <span class="friend-username">@{{ friend.username }}</span>
          </div>
          <div class="friend-check">
            <span class="material-symbols-outlined">{{ isFriendSelected(friend.id) ? 'check_circle' :
              'radio_button_unchecked' }}</span>
          </div>
        </div>
        }
      </div>
      }
      }
    </div>

    <div class="friend-dialog-footer" *ngIf="!isFriendPickLoading() && !friendPickResult()">
      <button class="btn-secondary" (click)="closeFriendDialog()">{{ 'dialog.cancel' | translate }}</button>
      <button class="btn-primary" [disabled]="selectedFriends().size === 0" (click)="submitFriendPick()">
        {{ 'dashboard.findEpisode' | translate:{ count: selectedFriends().size } }}
      </button>
    </div>
  </div>
</div>