@if (isLoading()) {
<div class="loading-container">
  <div class="loading">Loading profile...</div>
</div>
} @else if (error()) {
<div class="error-container">
  <div class="error-message">{{ error() }}</div>
  <button class="back-btn" (click)="router.navigate(['/dashboard'])" type="button">Go Back</button>
</div>
} @else if (profile()) {
@let profileData = profile()!;
<div class="profile-container">
  <!-- Floating Ambient Orbs -->
  <div class="floating-orb floating-orb--primary"></div>
  <div class="floating-orb floating-orb--accent"></div>
  <div class="floating-orb floating-orb--secondary"></div>

  <app-header></app-header>

  <!-- Profile Hero Section -->
  <div class="profile-hero">
    <div class="hero-banner"
      [style.background-image]="profileData.user.banner ? 'url(' + profileData.user.banner + ')' : 'none'"
      [class.hero-banner--editable]="isOwnProfile()" (click)="isOwnProfile() && quickBannerInput.click()">

      @if (isOwnProfile()) {
      <div class="banner-edit-overlay">
        <div class="overlay-content">
          @if (isBannerLoading()) {
          <div class="spinner-small"></div>
          } @else {
          <span class="material-symbols-outlined">photo_camera</span>
          <span>Change Banner</span>
          }
        </div>
      </div>
      }
      <input type="file" #quickBannerInput (change)="onBannerQuickUpload($event)" accept="image/*" hidden>
    </div>
    <div class="hero-content">
      <div class="profile-header">
        <div class="profile-avatar-section">
          <div class="profile-avatar-large">
            @if (profileData.user.avatar) {
            <img [src]="profileData.user.avatar" alt="Profile Avatar" class="avatar-img-large">
            } @else {
            <div class="avatar-image"></div>
            }
            @if (isOwnProfile()) {
            <button class="edit-avatar-btn" (click)="openEditProfile()">
              <span class="material-symbols-outlined">edit</span>
            </button>
            }
          </div>
        </div>
        <div class="profile-info">
          <div class="profile-title-section">
            <div>
              <h1 class="profile-username">{{ profileData.user.name || profileData.user.username }}</h1>
              <p class="profile-bio">@{{ profileData.user.username }}</p>
            </div>
            <div class="profile-buttons">
              @if (isOwnProfile()) {
              <button class="edit-profile-btn" (click)="openEditProfile()">
                <span class="material-symbols-outlined">edit</span>
                <span>Edit Profile</span>
              </button>
              <button class="share-profile-btn" (click)="openShareDialog()">
                <span class="material-symbols-outlined">share</span>
                <span>Share</span>
              </button>
              } @else {
              @if (isFollowing()) {
              <button class="follow-btn following" (click)="unfollowUser()" [disabled]="isFollowLoading()">
                <span class="material-symbols-outlined">check</span>
                <span>Following</span>
              </button>
              } @else {
              <button class="follow-btn" (click)="followUser()" [disabled]="isFollowLoading()">
                <span class="material-symbols-outlined">person_add</span>
                <span>Follow</span>
              </button>
              }
              <button class="compare-mood-btn" (click)="openMoodComparison()">
                <span class="material-symbols-outlined">compare</span>
                <span>Compare Mood</span>
              </button>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-section">
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-value">{{ profileData.user.stats.moviesWatched }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">movie</span>
          <span>Watched</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ profileData.reviewCount }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">rate_review</span>
          <span>Reviews</span>
        </div>
      </div>
      <div class="stat-card stat-card--clickable" (click)="openFollowers()">
        <span class="stat-value">{{ formatNumber(profileData.user.followersCount) }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">group</span>
          <span>Followers</span>
        </div>
      </div>
      <div class="stat-card stat-card--clickable" (click)="openFollowing()">
        <span class="stat-value">{{ profileData.user.followingCount }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">person_add</span>
          <span>Following</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <div class="tabs-container">
      <button class="tab-item" [class.active]="activeTab() === 'profile'" (click)="onTabChange('profile')"
        type="button">
        <span>Profile</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'watchlist'" (click)="onTabChange('watchlist')"
        type="button">
        <span>Watchlist</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'lists'" (click)="onTabChange('lists')" type="button">
        <span>Lists</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'reviews'" (click)="onTabChange('reviews')"
        type="button">
        <span>Reviews</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'likes'" (click)="onTabChange('likes')" type="button">
        <span>Likes</span>
      </button>
    </div>
  </div>

  <!-- Content Section -->
  <div class="content-section">
    @if (activeTab() === 'profile') {
    <!-- Mood Charts Section -->
    @if (isOwnProfile()) {
    <div class="mood-section">
      <div class="mood-charts-grid">
        <app-mood-chart [moodData]="moodData()" [isLoading]="isLoadingMood()"></app-mood-chart>
        <app-mood-timeline [timelineData]="moodTimeline()" [isLoading]="isLoadingTimeline()"></app-mood-timeline>
      </div>
    </div>

    <!-- Badges Section -->
    <div class="badges-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="material-symbols-outlined section-icon">workspace_premium</span>
          Mood Badges
        </h2>
      </div>
      @if (isLoadingBadges()) {
      <div class="badges-loading">
        <div class="spinner"></div>
      </div>
      } @else if (badges().length > 0) {
      <div class="badges-slider-container">
        <button class="slider-btn prev" (click)="scrollBadges('left')">
          <span class="material-symbols-outlined">chevron_left</span>
        </button>

        <div class="badges-slider" #badgesContainer>
          @for (badge of badges(); track badge.id) {
          <div class="badge-item" [class.earned]="badge.earnedAt" [title]="badge.description">
            <span class="badge-icon">{{ badge.icon }}</span>
            <span class="badge-name">{{ badge.name }}</span>
            @if (!badge.earnedAt && badge.progress !== undefined && badge.threshold) {
            <div class="badge-progress">
              <div class="badge-progress-bar" [style.width.%]="(badge.progress / badge.threshold) * 100"></div>
            </div>
            <span class="badge-progress-text">{{ badge.progress }}/{{ badge.threshold }}</span>
            }
          </div>
          }
        </div>

        <button class="slider-btn next" (click)="scrollBadges('right')">
          <span class="material-symbols-outlined">chevron_right</span>
        </button>
      </div>
      } @else {
      <div class="badges-empty">
        <p>Watch and rate movies to earn badges!</p>
      </div>
      }
    </div>

    <!-- Mood Recommendations Section -->
    <div class="badges-section recommendations-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="material-symbols-outlined section-icon">movie_filter</span>
          For Your Mood
        </h2>

        <!-- Controls -->
        <div class="mood-controls">
          <button class="mood-toggle-btn" (click)="toggleMoodRecsMode()">
            <span class="material-symbols-outlined">{{ moodRecsMode() === 'match' ? 'favorite' : 'swap_horiz' }}</span>
            {{ moodRecsMode() === 'match' ? 'Match' : 'Shift' }}
          </button>
          <button class="mood-toggle-btn" [class.active]="includeWatched()" (click)="toggleIncludeWatched()">
            <span class="material-symbols-outlined">{{ includeWatched() ? 'visibility' : 'visibility_off' }}</span>
            {{ includeWatched() ? 'All' : 'Unwatched' }}
          </button>
        </div>
      </div>
      @if (isLoadingRecommendations()) {
      <div class="badges-loading">
        <div class="spinner"></div>
      </div>
      } @else if (moodRecommendations().length > 0) {
      <div class="badges-slider-container">
        <button class="slider-btn prev" (click)="scrollRecommendations('left')">
          <span class="material-symbols-outlined">chevron_left</span>
        </button>

        <div class="badges-slider" #recommendationsContainer>
          @for (rec of moodRecommendations(); track rec.tmdbId) {
          <div class="recommendation-card" (click)="router.navigate(['/movies', rec.tmdbId])">
            <img [src]="tmdbService.getPosterUrl(rec.posterPath, 'w300')" [alt]="rec.title" class="rec-poster" />
            <div class="rec-overlay">
              <span class="material-symbols-outlined">play_circle</span>
            </div>
            <div class="rec-score" [title]="'Match Score: ' + rec.score + '%'">
              {{ rec.score }}%
            </div>
          </div>
          }
        </div>

        <button class="slider-btn next" (click)="scrollRecommendations('right')">
          <span class="material-symbols-outlined">chevron_right</span>
        </button>
      </div>
      } @else {
      <div class="badges-empty">
        <p>No mood recommendations available right now.</p>
      </div>
      }
    </div>
    }
    <!-- Director's Cut (Movies) Section -->
    @if (profileData.user.favoriteMovies.length > 0) {
    <div class="favorites-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="material-symbols-outlined section-icon">movie</span>
          Director's Movie Cut (Favorites)
        </h2>
        @if (isOwnProfile()) {
        <button class="section-edit-btn" (click)="openEditFavorites('movies')">
          <span class="material-symbols-outlined">edit</span>
          Edit
        </button>
        }
      </div>
      <div class="favorites-grid">
        @for (movie of profileData.user.favoriteMovies; track movie.tmdbId) {
        <div class="favorite-item" (click)="router.navigate(['/movies', movie.tmdbId])">
          <img [src]="tmdbService.getPosterUrl(movie.posterPath, 'w300')" [alt]="movie.title" class="favorite-poster" />
          <div class="favorite-overlay">
            <span class="material-symbols-outlined">visibility</span>
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- Director's Cut (TV Shows) Section -->
    @if (profileData.user.favoriteTvShows.length > 0) {
    <div class="favorites-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="material-symbols-outlined section-icon">tv</span>
          Director's TV Shows Cut (Favorites)
        </h2>
        @if (isOwnProfile()) {
        <button class="section-edit-btn" (click)="openEditFavorites('tv')">
          <span class="material-symbols-outlined">edit</span>
          Edit
        </button>
        }
      </div>
      <div class="favorites-grid">
        @for (show of profileData.user.favoriteTvShows; track show.tmdbId) {
        <div class="favorite-item" (click)="router.navigate(['/tv', show.tmdbId])">
          <img [src]="tmdbService.getPosterUrl(show.posterPath, 'w300')" [alt]="show.name" class="favorite-poster" />
          <div class="favorite-overlay">
            <span class="material-symbols-outlined">visibility</span>
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- Recent Activity Section -->
    @if (profileData.recentActivities.length > 0) {
    <div class="activity-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="material-symbols-outlined section-icon">history</span>
          Recent Activity
        </h2>
        <a class="section-view-all" href="#">
          View all
          <span class="material-symbols-outlined">arrow_forward</span>
        </a>
      </div>
      <div class="activity-carousel">
        @for (activity of profileData.recentActivities; track activity._id) {
        <div class="activity-card">
          <div class="activity-image">
            <img [src]="tmdbService.getPosterUrl(activity.mediaPosterPath, 'w500')" [alt]="activity.mediaTitle" />
            @if (activity.rating) {
            <div class="activity-rating-badge">
              <span class="material-symbols-outlined">star</span>
              <span>{{ activity.rating.toFixed(1) }}</span>
            </div>
            }
          </div>
          <div class="activity-info">
            <h3 class="activity-title">{{ activity.mediaTitle }}</h3>
            <div class="activity-meta">
              <span class="activity-time">{{ getTimeAgo(activity.createdAt) }}</span>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }
    }
  </div>
</div>

<!-- Followers/Following Dialog -->
@if (showUserListDialog()) {
<div class="user-list-dialog-backdrop" (click)="closeUserListDialog()">
  <div class="user-list-dialog" (click)="$event.stopPropagation()">
    <div class="user-list-dialog-header">
      <h3>{{ userListType() === 'followers' ? 'Followers' : 'Following' }}</h3>
      <button class="dialog-close" (click)="closeUserListDialog()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="user-list-dialog-body">
      @if (isUserListLoading()) {
      <div class="user-list-loading">
        <div class="spinner"></div>
      </div>
      } @else if (userList().length === 0) {
      <div class="user-list-empty">
        <span class="material-symbols-outlined">person_off</span>
        <p>{{ userListType() === 'followers' ? 'No followers yet' : 'Not following anyone yet' }}</p>
      </div>
      } @else {
      <div class="user-list">
        @for (user of userList(); track user.id) {
        <div class="user-item">
          <div class="user-item-info" (click)="router.navigate(['/profile', user.username]); closeUserListDialog()">
            <div class="user-avatar">
              <span class="material-symbols-outlined">person</span>
            </div>
            <div class="user-info">
              <span class="user-nickname">{{ user.name || user.username }}</span>
              <span class="user-username">@{{ user.username }}</span>
            </div>
          </div>
          @if (isOwnProfile()) {
          <button class="user-action-btn"
            (click)="userListType() === 'followers' ? removeFromList(user.id) : unfollowFromList(user.id)">
            {{ userListType() === 'followers' ? 'Remove' : 'Unfollow' }}
          </button>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}

<!-- Edit Profile Dialog -->
@if (showEditProfileDialog()) {
<div class="user-list-dialog-backdrop" (click)="closeEditProfile()">
  <div class="user-list-dialog edit-profile-dialog" (click)="$event.stopPropagation()">
    <div class="user-list-dialog-header">
      <h3>Edit Profile</h3>
      <button class="dialog-close" (click)="closeEditProfile()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="edit-profile-body">
      <!-- Avatar Section -->
      <div class="form-group">
        <label>Avatar URL</label>
        <div class="avatar-input-wrapper">
          <div class="avatar-preview">
            @if (editAvatar()) {
            <img [src]="editAvatar()" alt="Avatar preview" onError="this.style.display='none'">
            } @else {
            <div class="avatar-placeholder">
              <span class="material-symbols-outlined">person</span>
            </div>
            }
          </div>
          <div class="avatar-upload-controls">
            <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" hidden>
            <button class="upload-btn" (click)="fileInput.click()" type="button">
              <span class="material-symbols-outlined">upload_file</span>
              {{ selectedFile ? 'Change Image' : 'Choose Image' }}
            </button>
            <p class="help-text">Max size: 1MB. JPG, PNG or WebP.</p>
          </div>
        </div>
      </div>

      <!-- Banner Section -->
      <div class="form-group">
        <label>Banner Image</label>
        <div class="banner-upload-wrapper">
          <input type="file" #bannerInput (change)="onBannerSelected($event)" accept="image/*" hidden>
          <div class="banner-preview clickable" (click)="bannerInput.click()">
            @if (editBanner()) {
            <img [src]="editBanner()" alt="Banner preview" class="banner-preview-img"
              onError="this.style.display='none'">
            <div class="banner-hover-overlay">
              <span class="material-symbols-outlined">edit</span>
              <span>Change Banner</span>
            </div>
            } @else {
            <div class="banner-placeholder">
              <span class="material-symbols-outlined">add_photo_alternate</span>
              <p>Click to select banner</p>
            </div>
            }
          </div>
          <p class="help-text banner-help">Max size: 2MB. 1200x350px.</p>
        </div>
      </div>

      <!-- Real Name Section -->
      <div class="form-group">
        <label>Real Name</label>
        <input type="text" [ngModel]="editName()" (ngModelChange)="editName.set($event)"
          placeholder="Enter your full name..." class="form-input" maxlength="100">
      </div>

      <!-- Username Section -->
      <div class="form-group">
        <label>Username</label>
        <input type="text" [ngModel]="editUsername()" (ngModelChange)="editUsername.set($event)"
          placeholder="Choose a username..." class="form-input" maxlength="30" [disabled]="!canChangeUsername()">
        @if (!canChangeUsername() && canChangeUsernameAt()) {
        <p class="username-restriction-text">
          <span class="material-symbols-outlined">schedule</span>
          You can change your username on {{ canChangeUsernameAt() | date:'mediumDate' }}
        </p>
        }
      </div>

    </div>

    <div class="dialog-actions">
      <button class="cancel-btn" (click)="closeEditProfile()">Cancel</button>
      <button class="save-btn" (click)="saveProfile()" [disabled]="isEditLoading()">
        @if (isEditLoading()) {
        <span class="spinner-small"></span>
        Saving...
        } @else {
        Save Changes
        }
      </button>
    </div>
  </div>
</div>

<!-- Mood Comparison Dialog -->
@if (showComparisonDialog()) {
<div class="dialog-overlay" (click)="closeComparisonDialog()">
  <div class="comparison-dialog" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2><span class="material-symbols-outlined">compare</span> Mood Comparison</h2>
      <button class="close-btn" (click)="closeComparisonDialog()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="dialog-body">
      @if (isLoadingComparison()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Comparing mood profiles...</p>
      </div>
      } @else if (moodComparison()) {
      <div class="comparison-content">
        <div class="similarity-section">
          <div class="similarity-circle" [class.high]="moodComparison()!.similarity >= 75">
            <span class="similarity-value">{{ moodComparison()!.similarity }}%</span>
            <span class="similarity-label">Match</span>
          </div>
          <p class="similarity-text">
            @if (moodComparison()!.similarity >= 80) { You're cinematic soulmates! üé¨üíï }
            @else if (moodComparison()!.similarity >= 60) { You have similar movie vibes! üé• }
            @else if (moodComparison()!.similarity >= 40) { Some overlap in your tastes üéûÔ∏è }
            @else { Different perspectives, different movies! üåà }
          </p>
        </div>
        <div class="dimension-comparison">
          <h3>Dimension Breakdown</h3>
          <div class="dimensions-list">
            @for (dim of moodComparison()!.dimensionComparison; track dim.dimension) {
            <div class="dimension-row">
              <span class="dim-label">{{ getDimensionLabel(dim.dimension) }}</span>
              <div class="dim-bars">
                <div class="bar-container you">
                  <div class="bar" [style.width.%]="dim.user1Value"></div><span class="bar-value">{{ dim.user1Value
                    }}</span>
                </div>
                <div class="bar-container them">
                  <div class="bar" [style.width.%]="dim.user2Value"></div><span class="bar-value">{{ dim.user2Value
                    }}</span>
                </div>
              </div>
            </div>
            }
          </div>
          <div class="legend">
            <span class="legend-item you"><span class="dot"></span> You</span>
            <span class="legend-item them"><span class="dot"></span> {{ profile()?.user?.name ||
              profile()?.user?.username }}</span>
          </div>
        </div>
        @if (moodComparison()!.commonStrengths.length > 0) {
        <div class="strengths-section">
          <h3>Shared Strengths</h3>
          <div class="strength-tags">
            @for (s of moodComparison()!.commonStrengths; track s) {
            <span class="strength-tag common">{{ getDimensionLabel(s) }}</span>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}
}
}
<app-share-dialog [isOpen]="showShareDialog()" [profile]="profile()" [moodData]="moodData()" [badges]="badges()"
  [close]="closeShareDialog">
</app-share-dialog>

<!-- Edit Favorites Dialog -->
@if (showEditFavoritesDialog() && profile(); as p) {
<app-edit-favorites-dialog [isOpen]="showEditFavoritesDialog()" [initialMovies]="p.user.favoriteMovies"
  [initialTvShows]="p.user.favoriteTvShows" [initialTab]="editFavoritesTab()" (close)="closeEditFavoritesDialog()"
  (save)="saveFavorites($event)">
</app-edit-favorites-dialog>
}