@if (isLoading()) {
<div class="loading-container">
  <div class="loading">{{ 'profile.loadingProfile' | translate }}</div>
</div>
} @else if (error()) {
<div class="error-container">
  <div class="error-message">{{ error() }}</div>
  <button class="back-btn" (click)="router.navigate(['/dashboard'])" type="button">{{ 'profile.goBack' | translate
    }}</button>
</div>
} @else if (profile()) {
@let profileData = profile()!;
<div class="profile-container">
  <!-- Floating Ambient Orbs -->
  <div class="floating-orb floating-orb--primary"></div>
  <div class="floating-orb floating-orb--accent"></div>
  <div class="floating-orb floating-orb--secondary"></div>

  <app-header></app-header>

  <!-- Profile Header Component -->
  <app-profile-header [user]="profileData.user" [isOwnProfile]="isOwnProfile()" [isFollowing]="isFollowing()"
    [isFollowLoading]="isFollowLoading()" [isBannerLoading]="isBannerLoading()" (onEdit)="openEditProfile()"
    (onFollow)="followUser()" (onUnfollow)="unfollowUser()" (onShare)="openShareDialog()" (onReport)="openReports()"
    (onCompareMood)="openMoodComparison()" (onBannerChange)="handleBannerUpload($event)" />

  <!-- Stats Component -->
  <app-profile-stats [stats]="profileData.user.stats" [reviewCount]="profileData.reviewCount"
    [followersCount]="profileData.user.followersCount" [followingCount]="profileData.user.followingCount"
    (onFollowersClick)="openFollowers()" (onFollowingClick)="openFollowing()" />

  <!-- Tab Navigation Component -->
  <div class="tabs-section">
    <app-tab-navigation [tabs]="profileTabs" [activeTab]="activeTab()" (tabChanged)="onTabChange($event)" />
  </div>

  <!-- Content Section -->
  <div class="content-container">
    <div class="content-section">
      @if (activeTab() === 'profile') {

      <!-- Taste Match Section (Other User's Profile) -->


      <!-- Mood Charts Section -->
      @if (isOwnProfile()) {
      <div class="mood-section">
        <div class="section-header mood-section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">psychology</span>
            {{ 'profile.cinematicMood' | translate }}
          </h2>
          @if (isDev) {
          <button class="refresh-all-btn" (click)="refreshMood()" [disabled]="isRefreshingAllMood()">
            @if (isRefreshingAllMood()) {
            <span class="material-symbols-outlined spinning">sync</span>
            <span>{{ 'profile.refreshing' | translate }}</span>
            } @else {
            <span class="material-symbols-outlined">refresh</span>
            <span>{{ 'profile.refreshAll' | translate }}</span>
            }
          </button>
          }
        </div>
        @if (aiThresholdNotMet() && aiThresholdMeta()) {
        <!-- Locked State: Not enough rated movies for Mood Analysis -->
        <div class="ai-locked-state">
          <div class="locked-icon">
            <span class="material-symbols-outlined">lock</span>
          </div>
          <h3 class="locked-title">{{ 'profile.aiLocked' | translate }}</h3>
          <p class="locked-message">{{ 'profile.aiLockedMessage' | translate }}</p>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill"
                [style.width.%]="(aiThresholdMeta()!.currentCount / aiThresholdMeta()!.requiredCount) * 100"></div>
            </div>
            <span class="progress-text">{{ aiThresholdMeta()!.currentCount }} / {{ aiThresholdMeta()!.requiredCount
              }}</span>
          </div>
          <p class="remaining-hint">{{ 'profile.aiLockedRemaining' | translate:{ remaining: aiThresholdMeta()!.remaining
            } }}</p>
        </div>
        } @else {
        <!-- Mood Charts with @defer for performance -->
        @defer (on viewport) {
        <div class="mood-charts-grid">
          <app-mood-chart [moodData]="moodData()" [isLoading]="isLoadingMood()"></app-mood-chart>

          <div class="timeline-container">
            <app-mood-timeline [timelineData]="moodTimeline()" [isLoading]="isLoadingTimeline()"></app-mood-timeline>

            @if (!hasEnoughTimelineData()) {
            <div class="timeline-overlay">
              <div class="overlay-content">
                <span class="material-symbols-outlined">info</span>
                <p>{{ 'profile.timelineInfo' | translate }}</p>
                <span class="timeline-progress">{{ moodTimeline().length }}/3 {{ 'profile.days' | translate }}</span>
              </div>
            </div>
            }
          </div>
        </div>
        } @placeholder {
        <div class="mood-charts-loading">
          <div class="spinner"></div>
        </div>
        }
        }
      </div>

      <!-- Badges Section -->
      <div class="badges-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">workspace_premium</span>
            {{ 'profile.moodBadges' | translate }}
          </h2>
        </div>
        <app-carousel [items]="badges()" [loading]="isLoadingBadges()"
          [emptyMessage]="'profile.earnBadgesHint' | translate">
          <ng-container *ngFor="let badge of badges(); trackBy: trackByBadgeId">
            <div class="badge-item" [class.earned]="badge.earnedAt" [title]="badge.description">
              <span class="badge-icon">{{ badge.icon }}</span>
              @if (!badge.earnedAt && badge.progress !== undefined && badge.threshold) {
              <div class="badge-progress">
                <div class="badge-progress-bar" [style.width.%]="(badge.progress / badge.threshold) * 100"></div>
              </div>
              <span class="badge-progress-text">{{ badge.progress }}/{{ badge.threshold }}</span>
              }
              <span class="badge-name">{{ badge.name }}</span>
            </div>
          </ng-container>
        </app-carousel>
      </div>

      <!-- Mood Recommendations Section -->
      <div class="badges-section recommendations-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">movie_filter</span>
            {{ 'profile.forYourMood' | translate }}
          </h2>

          <!-- Controls -->
          <div class="mood-controls">
            <button class="mood-toggle-btn" (click)="toggleMoodRecsMode()"
              [attr.data-tooltip]="(moodRecsMode() === 'match' ? 'profile.matchTooltip' : 'profile.shiftTooltip') | translate">
              <span class="material-symbols-outlined">{{ moodRecsMode() === 'match' ? 'favorite' : 'swap_horiz'
                }}</span>
              {{ (moodRecsMode() === 'match' ? 'profile.match' : 'profile.shift') | translate }}
            </button>
            <button class="mood-toggle-btn" [class.active]="includeWatched()" (click)="toggleIncludeWatched()">
              <span class="material-symbols-outlined">{{ includeWatched() ? 'visibility' : 'visibility_off' }}</span>
              {{ (includeWatched() ? 'profile.all' : 'profile.unwatched') | translate }}
            </button>
          </div>
        </div>
        @if (isLoadingRecommendations()) {
        <div class="badges-loading">
          <div class="spinner"></div>
        </div>
        } @else if (aiThresholdNotMet() && aiThresholdMeta()) {
        <!-- Locked State: Not enough rated movies -->
        <div class="ai-locked-state">
          <div class="locked-icon">
            <span class="material-symbols-outlined">lock</span>
          </div>
          <h3 class="locked-title">{{ 'profile.aiLocked' | translate }}</h3>
          <p class="locked-message">{{ 'profile.aiLockedMessage' | translate }}</p>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill"
                [style.width.%]="(aiThresholdMeta()!.currentCount / aiThresholdMeta()!.requiredCount) * 100"></div>
            </div>
            <span class="progress-text">{{ aiThresholdMeta()!.currentCount }} / {{ aiThresholdMeta()!.requiredCount
              }}</span>
          </div>
          <p class="remaining-hint">{{ 'profile.aiLockedRemaining' | translate:{ remaining: aiThresholdMeta()!.remaining
            } }}</p>
        </div>
        } @else if (moodRecommendations().length > 0) {
        <!-- Premium Deck: 5 Interactive Cards -->
        <div class="carousel-container">
          @if (isPremiumDeckScrollable()) {
          <button class="carousel-btn carousel-btn--left" (click)="scrollPremiumDeck('left')" aria-label="Scroll left">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>
          }

          <div class="carousel-grid" #premiumDeckGrid>
            @for (rec of moodRecommendations(); track rec.tmdbId) {
            <app-media-card [title]="rec.title" [posterPath]="rec.posterPath" [matchScore]="rec.score"
              [isRated]="isCardRated(rec.tmdbId)" (cardClick)="router.navigate(['/movies', rec.tmdbId])">

              <!-- Feedback Buttons (via content projection) -->
              @if (!isCardRated(rec.tmdbId)) {
              <div class="feedback-buttons">
                <button class="feedback-btn like" (click)="rateCard(rec, 'like'); $event.stopPropagation()"
                  title="{{ 'profile.like' | translate }}">
                  <span class="material-symbols-outlined">thumb_up</span>
                </button>
                <button class="feedback-btn dislike" (click)="rateCard(rec, 'dislike'); $event.stopPropagation()"
                  title="{{ 'profile.dislike' | translate }}">
                  <span class="material-symbols-outlined">thumb_down</span>
                </button>
              </div>
              }

              <!-- Replace Overlay -->
              @if (isCardRated(rec.tmdbId)) {
              <div class="replace-overlay">
                <button class="replace-btn" (click)="replaceCard(rec.tmdbId); $event.stopPropagation()"
                  [disabled]="replacementQuota().remaining <= 0">
                  <span class="material-symbols-outlined">refresh</span>
                  <span>{{ 'profile.replaceCard' | translate }}</span>
                  <span class="quota-badge">({{ replacementQuota().remaining }}/{{ replacementQuota().total }})</span>
                </button>
              </div>
              }
            </app-media-card>
            }
          </div>

          @if (isPremiumDeckScrollable()) {
          <button class="carousel-btn carousel-btn--right" (click)="scrollPremiumDeck('right')"
            aria-label="Scroll right">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
          }
        </div>
        } @else {
        <div class="badges-empty">
          <p>{{ 'profile.noMoodRecs' | translate }}</p>
        </div>
        }
      </div>
      }

      <!-- Director's Cut (Movies) Section -->
      @if (profileData.user.favoriteMovies.length > 0) {
      <div class="favorites-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">movie</span>
            {{ 'profile.directorsMovieCut' | translate }}
          </h2>
          @if (isOwnProfile()) {
          <button class="section-edit-btn" (click)="openEditFavorites('movies')">
            <span class="material-symbols-outlined">edit</span>
            {{ 'profile.edit' | translate }}
          </button>
          }
        </div>
        <div class="carousel-container">
          @if (isMoviesFavoritesScrollable()) {
          <button class="carousel-btn carousel-btn--left" (click)="scrollCarousel($event, 'left')"
            aria-label="Scroll left">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>
          }
          <div class="carousel-grid" #moviesFavoritesGrid>
            @for (movie of profileData.user.favoriteMovies; track movie.tmdbId) {
            <app-media-card [title]="movie.title" [posterPath]="movie.posterPath"
              (cardClick)="router.navigate(['/movies', movie.tmdbId])" />
            }
          </div>
          @if (isMoviesFavoritesScrollable()) {
          <button class="carousel-btn carousel-btn--right" (click)="scrollCarousel($event, 'right')"
            aria-label="Scroll right">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
          }
        </div>
      </div>
      }

      <!-- Director's Cut (TV Shows) Section -->
      @if (profileData.user.favoriteTvShows.length > 0) {
      <div class="favorites-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">tv</span>
            {{ 'profile.directorsTvCut' | translate }}
          </h2>
          @if (isOwnProfile()) {
          <button class="section-edit-btn" (click)="openEditFavorites('tv')">
            <span class="material-symbols-outlined">edit</span>
            {{ 'profile.edit' | translate }}
          </button>
          }
        </div>
        <div class="carousel-container">
          @if (isTvFavoritesScrollable()) {
          <button class="carousel-btn carousel-btn--left" (click)="scrollCarousel($event, 'left')"
            aria-label="Scroll left">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>
          }
          <div class="carousel-grid" #tvFavoritesGrid>
            @for (show of profileData.user.favoriteTvShows; track show.tmdbId) {
            <app-media-card [title]="show.name" [posterPath]="show.posterPath"
              (cardClick)="router.navigate(['/tv', show.tmdbId])" />
            }
          </div>
          @if (isTvFavoritesScrollable()) {
          <button class="carousel-btn carousel-btn--right" (click)="scrollCarousel($event, 'right')"
            aria-label="Scroll right">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
          }
        </div>
      </div>
      }

      } @else if (activeTab() === 'lists') {
      <!-- Lists Tab Content (kept as-is for now) -->
      <div class="lists-tab-content">
        <!-- View Toggle -->
        <div class="lists-view-toggle">
          <button class="view-toggle-btn" [class.active]="listsViewMode() === 'slider'"
            (click)="listsViewMode.set('slider')">
            <span class="material-symbols-outlined">view_carousel</span>
            <span>{{ 'profile.sliderView' | translate }}</span>
          </button>
          <button class="view-toggle-btn" [class.active]="listsViewMode() === 'list'"
            (click)="listsViewMode.set('list')">
            <span class="material-symbols-outlined">list</span>
            <span>{{ 'profile.listView' | translate }}</span>
          </button>
        </div>

        @if (listsViewMode() === 'slider') {
        <!-- Watched List Section -->
        @if (watched(); as watchedList) {
        <div class="list-card">
          <div class="list-card-header">
            <div class="list-card-title">
              <span class="material-symbols-outlined list-icon">visibility</span>
              <h3>{{ 'watched.title' | translate }}</h3>
              <span class="list-badge">{{ watchedList.items.length }}</span>
            </div>
            <div class="list-card-actions">
              @if (isOwnProfile()) {
              <div class="privacy-dropdown-container">
                <button class="privacy-btn" (click)="togglePrivacyDropdown('watched', $event)">
                  <span class="material-symbols-outlined">{{ getPrivacyIcon(watchedList.privacyStatus) }}</span>
                </button>
                @if (activePrivacyDropdown() === 'watched') {
                <div class="privacy-dropdown" (click)="$event.stopPropagation()">
                  <button class="privacy-option" [class.active]="watchedList.privacyStatus === 0"
                    (click)="updateWatchedPrivacy(0)">
                    <span class="material-symbols-outlined">public</span>
                    <span>{{ 'privacy.everyone' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchedList.privacyStatus === 1"
                    (click)="updateWatchedPrivacy(1)">
                    <span class="material-symbols-outlined">group</span>
                    <span>{{ 'privacy.friends' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchedList.privacyStatus === 2"
                    (click)="updateWatchedPrivacy(2)">
                    <span class="material-symbols-outlined">lock</span>
                    <span>{{ 'privacy.nobody' | translate }}</span>
                  </button>
                </div>
                }
              </div>
              }
              <button class="expand-btn" routerLink="/lists/watched">
                <span>{{ 'profile.viewAll' | translate }}</span>
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>
          </div>

          @if (watchedList.items.length > 0) {
          <div class="list-slider-container">
            <button class="slider-btn prev" (click)="scrollWatched('left')">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>

            <div class="list-slider" #watchedContainer>
              @for (item of watchedList.items.slice(0, 20); track item.tmdbId) {
              <div class="list-poster-card"
                (click)="router.navigate([item.mediaType === 'tv' ? '/tv' : '/movies', item.tmdbId])">
                @if (item.posterPath) {
                <img [src]="tmdbService.getPosterUrl(item.posterPath, 'w300')" [alt]="item.title" class="poster-img" />
                } @else {
                <div class="poster-placeholder">
                  <span class="material-symbols-outlined">movie</span>
                </div>
                }
                <div class="poster-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </div>
                @if (item.rating) {
                <div class="poster-rating">
                  <span class="material-symbols-outlined">star</span>
                  {{ item.rating.toFixed(1) }}
                </div>
                }
              </div>
              }
            </div>

            <button class="slider-btn next" (click)="scrollWatched('right')">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          } @else {
          <div class="list-empty">
            <span class="material-symbols-outlined">movie</span>
            <p>{{ 'watched.empty' | translate }}</p>
          </div>
          }
        </div>
        }

        <!-- Default Watchlist Section -->
        @if (defaultWatchlist(); as watchlist) {
        <div class="list-card">
          <div class="list-card-header">
            <div class="list-card-title">
              <span class="material-symbols-outlined list-icon">bookmark</span>
              <h3>{{ 'watchlist.title' | translate }}</h3>
              <span class="list-badge">{{ watchlist.items.length }}</span>
            </div>
            <div class="list-card-actions">
              @if (isOwnProfile()) {
              <div class="privacy-dropdown-container">
                <button class="privacy-btn" (click)="togglePrivacyDropdown('watchlist', $event)">
                  <span class="material-symbols-outlined">{{ getPrivacyIcon(watchlist.privacyStatus) }}</span>
                </button>
                @if (activePrivacyDropdown() === 'watchlist') {
                <div class="privacy-dropdown" (click)="$event.stopPropagation()">
                  <button class="privacy-option" [class.active]="watchlist.privacyStatus === 0"
                    (click)="updateWatchlistPrivacy(watchlist._id, 0)">
                    <span class="material-symbols-outlined">public</span>
                    <span>{{ 'privacy.everyone' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchlist.privacyStatus === 1"
                    (click)="updateWatchlistPrivacy(watchlist._id, 1)">
                    <span class="material-symbols-outlined">group</span>
                    <span>{{ 'privacy.friends' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchlist.privacyStatus === 2"
                    (click)="updateWatchlistPrivacy(watchlist._id, 2)">
                    <span class="material-symbols-outlined">lock</span>
                    <span>{{ 'privacy.nobody' | translate }}</span>
                  </button>
                </div>
                }
              </div>
              }
              <button class="expand-btn" routerLink="/lists/watchlist">
                <span>{{ 'profile.viewAll' | translate }}</span>
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>
          </div>

          @if (watchlist.items.length > 0) {
          <div class="list-slider-container">
            <button class="slider-btn prev" (click)="scrollWatchlist('left')">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>

            <div class="list-slider" #watchlistContainer>
              @for (item of watchlist.items.slice(0, 20); track item.tmdbId) {
              <div class="list-poster-card"
                (click)="router.navigate([item.mediaType === 'tv' ? '/tv' : '/movies', item.tmdbId])">
                @if (item.posterPath) {
                <img [src]="tmdbService.getPosterUrl(item.posterPath, 'w300')" [alt]="item.title" class="poster-img" />
                } @else {
                <div class="poster-placeholder">
                  <span class="material-symbols-outlined">movie</span>
                </div>
                }
                <div class="poster-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </div>
              </div>
              }
            </div>

            <button class="slider-btn next" (click)="scrollWatchlist('right')">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          } @else {
          <div class="list-empty">
            <span class="material-symbols-outlined">bookmark_border</span>
            <p>{{ 'watchlist.empty' | translate }}</p>
          </div>
          }
        </div>
        }

        <!-- Custom Lists Section -->
        @for (list of customWatchlists(); track list._id) {
        <div class="list-card">
          <div class="list-card-header">
            <div class="list-card-title">
              <span class="material-symbols-outlined list-icon">{{ list.icon || 'list' }}</span>
              <h3>{{ list.name }}</h3>
              <span class="list-badge">{{ list.items.length }}</span>
            </div>
            <div class="list-card-actions">
              @if (isOwnProfile()) {
              <div class="privacy-dropdown-container">
                <button class="privacy-btn" (click)="togglePrivacyDropdown(list._id, $event)">
                  <span class="material-symbols-outlined">{{ getPrivacyIcon(list.privacyStatus) }}</span>
                </button>
                @if (activePrivacyDropdown() === list._id) {
                <div class="privacy-dropdown" (click)="$event.stopPropagation()">
                  <button class="privacy-option" [class.active]="list.privacyStatus === 0"
                    (click)="updateWatchlistPrivacy(list._id, 0)">
                    <span class="material-symbols-outlined">public</span>
                    <span>{{ 'privacy.everyone' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="list.privacyStatus === 1"
                    (click)="updateWatchlistPrivacy(list._id, 1)">
                    <span class="material-symbols-outlined">group</span>
                    <span>{{ 'privacy.friends' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="list.privacyStatus === 2"
                    (click)="updateWatchlistPrivacy(list._id, 2)">
                    <span class="material-symbols-outlined">lock</span>
                    <span>{{ 'privacy.nobody' | translate }}</span>
                  </button>
                </div>
                }
              </div>
              }
              <button class="expand-btn" [routerLink]="['/lists', list._id]">
                <span>{{ 'profile.viewAll' | translate }}</span>
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>
          </div>

          @if (list.items.length > 0) {
          <div class="list-slider-container">
            <button class="slider-btn prev" (click)="scrollCustomList('list-' + list._id, 'left')">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>

            <div class="list-slider" [id]="'list-' + list._id">
              @for (item of list.items.slice(0, 20); track item.tmdbId) {
              <div class="list-poster-card"
                (click)="router.navigate([item.mediaType === 'tv' ? '/tv' : '/movies', item.tmdbId])">
                @if (item.posterPath) {
                <img [src]="tmdbService.getPosterUrl(item.posterPath, 'w300')" [alt]="item.title" class="poster-img" />
                } @else {
                <div class="poster-placeholder">
                  <span class="material-symbols-outlined">movie</span>
                </div>
                }
                <div class="poster-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </div>
              </div>
              }
            </div>

            <button class="slider-btn next" (click)="scrollCustomList('list-' + list._id, 'right')">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          } @else {
          <div class="list-empty">
            <span class="material-symbols-outlined">{{ list.icon || 'list' }}</span>
            <p>{{ 'watchlist.emptyList' | translate }}</p>
          </div>
          }
        </div>
        }
        } @else {
        <!-- Compact List View -->
        <div class="lists-compact-view">
          <!-- Watched List -->
          @if (watched(); as watchedList) {
          <a class="compact-list-item" routerLink="/lists/watched">
            <div class="compact-list-icon">
              <span class="material-symbols-outlined">visibility</span>
            </div>
            <div class="compact-list-info">
              <span class="compact-list-name">{{ 'watched.title' | translate }}</span>
              <span class="compact-list-count">{{ watchedList.items.length }} {{ 'watchlist.items' | translate }}</span>
            </div>
            <span class="material-symbols-outlined compact-list-arrow">chevron_right</span>
          </a>
          }

          <!-- Default Watchlist -->
          @if (defaultWatchlist(); as watchlist) {
          <a class="compact-list-item" routerLink="/lists/watchlist">
            <div class="compact-list-icon">
              <span class="material-symbols-outlined">bookmark</span>
            </div>
            <div class="compact-list-info">
              <span class="compact-list-name">{{ 'watchlist.title' | translate }}</span>
              <span class="compact-list-count">{{ watchlist.items.length }} {{ 'watchlist.items' | translate }}</span>
            </div>
            <span class="material-symbols-outlined compact-list-arrow">chevron_right</span>
          </a>
          }

          <!-- Custom Lists -->
          @for (list of customWatchlists(); track list._id) {
          <a class="compact-list-item" [routerLink]="['/lists', list._id]">
            <div class="compact-list-icon">
              <span class="material-symbols-outlined">{{ list.icon || 'list' }}</span>
            </div>
            <div class="compact-list-info">
              <span class="compact-list-name">{{ list.name }}</span>
              <span class="compact-list-count">{{ list.items.length }} {{ 'watchlist.items' | translate }}</span>
            </div>
            <span class="material-symbols-outlined compact-list-arrow">chevron_right</span>
          </a>
          }
        </div>
        }
      </div>
      } @else if (activeTab() === 'activities') {
      <div class="activities-tab-content">
        <!-- Filter Bar -->
        <div class="activity-filters">
          <div class="chip-list">
            <button class="chip" [class.active]="activityFilter() === 'ALL'" (click)="setActivityFilter('ALL')">
              {{ 'profile.filterAll' | translate }}
            </button>
            <button class="chip" [class.active]="activityFilter() === 'REVIEWS'" (click)="setActivityFilter('REVIEWS')">
              {{ 'profile.filterReviews' | translate }}
            </button>
            <button class="chip" [class.active]="activityFilter() === 'COMMENTS'"
              (click)="setActivityFilter('COMMENTS')">
              {{ 'profile.filterComments' | translate }}
            </button>
            <button class="chip" [class.active]="activityFilter() === 'RATINGS'" (click)="setActivityFilter('RATINGS')">
              {{ 'profile.filterRatings' | translate }}
            </button>
            <button class="chip" [class.active]="activityFilter() === 'IMPORTS'" (click)="setActivityFilter('IMPORTS')">
              {{ 'profile.filterImports' | translate }}
            </button>
          </div>
        </div>

        <!-- Activity List -->
        @if (isLoadingActivities() && activities().length === 0) {
        <div class="activities-loading">
          <div class="spinner"></div>
        </div>
        } @else if (activities().length > 0) {
        <div class="activities-list">
          @for (activity of activities(); track activity._id) {
          <app-activity-card [activity]="activity"></app-activity-card>
          }
        </div>

        @if (hasMoreActivities()) {
        <div class="load-more-container">
          <button class="load-more-btn" (click)="loadMoreActivities()" [disabled]="isLoadingActivities()">
            @if (isLoadingActivities()) {
            <span class="spinner-small"></span>
            } @else {
            {{ 'profile.loadMore' | translate }}
            }
          </button>
        </div>
        }
        } @else {
        <div class="activities-empty">
          <span class="material-symbols-outlined">
            @switch (activityFilter()) {
            @case ('REVIEWS') { rate_review }
            @case ('COMMENTS') { chat_bubble }
            @case ('RATINGS') { star }
            @case ('IMPORTS') { folder_open }
            @default { history }
            }
          </span>
          <p>
            @switch (activityFilter()) {
            @case ('REVIEWS') { {{ 'profile.noReviews' | translate }} }
            @case ('COMMENTS') { {{ 'profile.noComments' | translate }} }
            @case ('RATINGS') { {{ 'profile.noRatings' | translate }} }
            @case ('IMPORTS') { {{ 'profile.noImports' | translate }} }
            @default { {{ 'profile.noActivities' | translate }} }
            }
          </p>
        </div>
        }
      </div>
      } @else if (activeTab() === 'likes') {
      <!-- Likes Tab Content -->
      <div class="likes-tab-content">
        @if (isLoadingLikes() && likedActivities().length === 0) {
        <div class="activities-loading">
          <div class="spinner"></div>
        </div>
        } @else if (likedActivities().length > 0) {
        <div class="activities-list">
          @for (activity of likedActivities(); track activity._id) {
          <app-activity-card [activity]="activity" showReaction="like"></app-activity-card>
          }
        </div>

        @if (hasMoreLikes()) {
        <div class="load-more-container">
          <button class="load-more-btn" (click)="loadMoreLikes()" [disabled]="isLoadingLikes()">
            @if (isLoadingLikes()) {
            <span class="spinner-small"></span>
            } @else {
            {{ 'profile.loadMore' | translate }}
            }
          </button>
        </div>
        }
        } @else {
        <div class="activities-empty">
          <span class="material-symbols-outlined">favorite_border</span>
          <p>{{ 'profile.noLikes' | translate }}</p>
        </div>
        }
      </div>
      } @else if (activeTab() === 'settings') {
      <!-- Settings Tab Content -->
      <app-profile-settings></app-profile-settings>
      }
    </div>
  </div>
</div>

<!-- TMDB Legal Footer -->
<div class="tmdb-legal-footer">
  <img [src]="tmdbService.tmdbLogoUrl" alt="TMDB" class="tmdb-logo">
  <p>This product uses the TMDB API but is not endorsed or certified by TMDB.</p>
  <small>ZELOG Â© {{ currentYear }}</small>
</div>
}

<!-- Followers/Following Dialog -->
@if (showUserListDialog()) {
<div class="user-list-dialog-backdrop" (click)="closeUserListDialog()">
  <div class="user-list-dialog" (click)="$event.stopPropagation()">
    <div class="user-list-dialog-header">
      <h3>{{ (userListType() === 'followers' ? 'profile.followers' : 'profile.following') | translate }}</h3>
      <button class="dialog-close" (click)="closeUserListDialog()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="user-list-dialog-body">
      @if (isUserListLoading()) {
      <div class="user-list-loading">
        <div class="spinner"></div>
      </div>
      } @else if (userList().length === 0) {
      <div class="user-list-empty">
        <span class="material-symbols-outlined">person_off</span>
        <p>{{ (userListType() === 'followers' ? 'profile.noFollowers' : 'profile.notFollowingAnyone') | translate }}</p>
      </div>
      } @else {
      <div class="user-list">
        @for (user of userList(); track user.id) {
        <div class="user-item">
          <div class="user-item-info" (click)="router.navigate(['/profile', user.username]); closeUserListDialog()">
            <div class="user-avatar">
              <span class="material-symbols-outlined">person</span>
            </div>
            <div class="user-info">
              <span class="user-nickname">{{ user.name || user.username }}</span>
              <span class="user-username">@{{ user.username }}</span>
            </div>
          </div>
          @if (isOwnProfile()) {
          <button class="user-action-btn"
            (click)="userListType() === 'followers' ? removeFromList(user.id) : unfollowFromList(user.id)">
            {{ (userListType() === 'followers' ? 'profile.remove' : 'profile.unfollow') | translate }}
          </button>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}

<!-- Edit Profile Dialog -->
@if (showEditProfileDialog()) {
<div class="user-list-dialog-backdrop" (click)="closeEditProfile()">
  <div class="user-list-dialog edit-profile-dialog" (click)="$event.stopPropagation()">
    <div class="user-list-dialog-header">
      <h3>{{ 'profile.editProfile' | translate }}</h3>
      <button class="dialog-close" (click)="closeEditProfile()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="edit-profile-body">
      <!-- Avatar Section -->
      <div class="form-group">
        <label>{{ 'profile.avatarUrl' | translate }}</label>
        <div class="avatar-input-wrapper">
          <div class="avatar-preview">
            @if (editAvatar()) {
            <img [src]="editAvatar()" alt="Avatar preview" onError="this.style.display='none'">
            } @else {
            <div class="avatar-placeholder">
              <span class="material-symbols-outlined">person</span>
            </div>
            }
          </div>
          <div class="avatar-upload-controls">
            <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" hidden>
            <button class="upload-btn" (click)="fileInput.click()" type="button">
              <span class="material-symbols-outlined">upload_file</span>
              {{ (selectedFile ? 'profile.changeImage' : 'profile.chooseImage') | translate }}
            </button>
            <p class="help-text">{{ 'profile.avatarHint' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Banner Section -->
      <div class="form-group">
        <label>{{ 'profile.bannerImage' | translate }}</label>
        <div class="banner-upload-wrapper">
          <input type="file" #bannerInput (change)="onBannerSelected($event)" accept="image/*" hidden>
          <div class="banner-preview clickable" (click)="bannerInput.click()">
            @if (editBanner()) {
            <img [src]="editBanner()" alt="Banner preview" class="banner-preview-img"
              onError="this.style.display='none'">
            <div class="banner-hover-overlay">
              <span class="material-symbols-outlined">edit</span>
              <span>{{ 'profile.changeBanner' | translate }}</span>
            </div>
            } @else {
            <div class="banner-placeholder">
              <span class="material-symbols-outlined">add_photo_alternate</span>
              <p>{{ 'profile.clickToSelectBanner' | translate }}</p>
            </div>
            }
          </div>
          <p class="help-text banner-help">{{ 'profile.bannerHint' | translate }}</p>
        </div>
      </div>

      <!-- Real Name Section -->
      <div class="form-group">
        <label>{{ 'profile.realName' | translate }}</label>
        <input type="text" [ngModel]="editName()" (ngModelChange)="editName.set($event)"
          [placeholder]="'profile.realNamePlaceholder' | translate" class="form-input" maxlength="100">
      </div>

      <!-- Username Section -->
      <div class="form-group">
        <label>{{ 'profile.username' | translate }}</label>
        <input type="text" [ngModel]="editUsername()" (ngModelChange)="editUsername.set($event)"
          [placeholder]="'profile.usernamePlaceholder' | translate" class="form-input" maxlength="30"
          [disabled]="!canChangeUsername()">
        @if (!canChangeUsername() && canChangeUsernameAt()) {
        <p class="username-restriction-text">
          <span class="material-symbols-outlined">schedule</span>
          {{ 'profile.usernameChangeRestricted' | translate:{ date: (canChangeUsernameAt() | date:'mediumDate') || '' }
          }}
        </p>
        }
      </div>

    </div>

    <div class="dialog-actions">
      <button class="cancel-btn" (click)="closeEditProfile()">{{ 'profile.cancel' | translate }}</button>
      <button class="save-btn" (click)="saveProfile()" [disabled]="isEditLoading()">
        @if (isEditLoading()) {
        <span class="spinner-small"></span>
        {{ 'profile.saving' | translate }}
        } @else {
        {{ 'profile.saveChanges' | translate }}
        }
      </button>
    </div>
  </div>
</div>
}


<app-share-dialog [isOpen]="showShareDialog()" [profile]="profile()" [moodData]="moodData()" [badges]="badges()"
  [close]="closeShareDialog">
</app-share-dialog>

<!-- Edit Favorites Dialog -->
@if (showEditFavoritesDialog() && profile(); as p) {
<app-edit-favorites-dialog [isOpen]="showEditFavoritesDialog()" [initialMovies]="p.user.favoriteMovies"
  [initialTvShows]="p.user.favoriteTvShows" [initialTab]="editFavoritesTab()" (close)="closeEditFavoritesDialog()"
  (save)="saveFavorites($event)">
</app-edit-favorites-dialog>
}

<app-edit-list-dialog [isOpen]="showEditListDialog()" [listTitle]="selectedListForEdit()?.name || ''"
  [listIcon]="selectedListForEdit()?.icon || 'list'" [initialItems]="getEditListItems(selectedListForEdit())"
  [isDefault]="false" (close)="showEditListDialog.set(false)" (save)="saveCustomList($event)">
</app-edit-list-dialog>

<app-watched-reports-dialog [isOpen]="showReportsDialog()" (close)="showReportsDialog.set(false)">
</app-watched-reports-dialog>

<!-- Rating Dialog -->
@if (showRatingDialog() && ratingDialogMovie()) {
<app-rate-dialog [isOpen]="showRatingDialog()" [title]="ratingDialogMovie()!.title" [initialRating]="selectedRating()"
  (close)="cancelRating()" (save)="onRateRec($event)">
</app-rate-dialog>
}

<app-match-dialog [isOpen]="showMatchDialog() && !!matchResult()" [result]="matchResult()!"
  (close)="closeMatchDialog()">
</app-match-dialog>

<!-- Premium Plus Upgrade Modal -->
@if (showUpgradeModal()) {
<div class="upgrade-modal-backdrop" (click)="closeUpgradeModal()">
  <div class="upgrade-modal" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeUpgradeModal()">
      <span class="material-symbols-outlined">close</span>
    </button>

    <div class="upgrade-icon">
      <span class="material-symbols-outlined">stars</span>
    </div>

    <h2>{{ 'profile.premiumPlusRequired' | translate }}</h2>
    <p>{{ 'profile.tasteMatchPremiumMessage' | translate }}</p>

    <button class="upgrade-btn" [routerLink]="['/settings']" [queryParams]="{tab: 'subscription'}"
      (click)="closeUpgradeModal()">
      <span class="material-symbols-outlined">rocket_launch</span>
      {{ 'profile.upgradeToPremiumPlus' | translate }}
    </button>
  </div>
</div>
}