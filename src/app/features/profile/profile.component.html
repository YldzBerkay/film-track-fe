@if (isLoading()) {
<div class="loading-container">
  <div class="loading">{{ 'profile.loadingProfile' | translate }}</div>
</div>
} @else if (error()) {
<div class="error-container">
  <div class="error-message">{{ error() }}</div>
  <button class="back-btn" (click)="router.navigate(['/dashboard'])" type="button">{{ 'profile.goBack' | translate
    }}</button>
</div>
} @else if (profile()) {
@let profileData = profile()!;
<div class="profile-container">
  <!-- Floating Ambient Orbs -->
  <div class="floating-orb floating-orb--primary"></div>
  <div class="floating-orb floating-orb--accent"></div>
  <div class="floating-orb floating-orb--secondary"></div>

  <app-header></app-header>

  <!-- Profile Hero Section -->
  <div class="profile-hero">
    <div class="hero-banner"
      [style.background-image]="profileData.user.banner ? 'url(' + profileData.user.banner + ')' : 'none'"
      [class.hero-banner--editable]="isOwnProfile()" (click)="isOwnProfile() && quickBannerInput.click()">

      @if (isOwnProfile()) {
      <div class="banner-edit-overlay">
        <div class="overlay-content">
          @if (isBannerLoading()) {
          <div class="spinner-small"></div>
          } @else {
          <span class="material-symbols-outlined">photo_camera</span>
          <span>{{ 'profile.changeBanner' | translate }}</span>
          }
        </div>
      </div>
      }
      <input type="file" #quickBannerInput (change)="onBannerQuickUpload($event)" accept="image/*" hidden>
    </div>
    <div class="hero-content">
      <div class="profile-header">
        <div class="profile-avatar-section">
          <div class="profile-avatar-large">
            @if (profileData.user.avatar) {
            <img [src]="profileData.user.avatar" alt="Profile Avatar" class="avatar-img-large">
            } @else {
            <div class="avatar-image"></div>
            }
            @if (isOwnProfile()) {
            <button class="edit-avatar-btn" (click)="openEditProfile()">
              <span class="material-symbols-outlined">edit</span>
            </button>
            }
          </div>
        </div>
        <div class="profile-info">
          <div class="profile-title-section">
            <div>
              <h1 class="profile-username">{{ profileData.user.name || profileData.user.username }}</h1>
              <p class="profile-bio">@{{ profileData.user.username }}</p>
            </div>
            <div class="profile-buttons">
              @if (isOwnProfile()) {
              <button class="edit-profile-btn" (click)="openEditProfile()">
                <span class="material-symbols-outlined">edit</span>
                <span>{{ 'profile.editProfile' | translate }}</span>
              </button>
              <button class="share-profile-btn" (click)="openShareDialog()">
                <span class="material-symbols-outlined">share</span>
                <span>{{ 'profile.share' | translate }}</span>
              </button>
              } @else {
              @if (isFollowing()) {
              <button class="follow-btn following" (click)="unfollowUser()" [disabled]="isFollowLoading()">
                <span class="material-symbols-outlined">check</span>
                <span>{{ 'profile.following' | translate }}</span>
              </button>
              } @else {
              <button class="follow-btn" (click)="followUser()" [disabled]="isFollowLoading()">
                <span class="material-symbols-outlined">person_add</span>
                <span>{{ 'profile.follow' | translate }}</span>
              </button>
              }
              <button class="compare-mood-btn" (click)="openMoodComparison()">
                <span class="material-symbols-outlined">compare</span>
                <span>{{ 'profile.compareMood' | translate }}</span>
              </button>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-section">
    <div class="stats-grid">
      <div class="stat-card stat-card--clickable" (click)="router.navigate(['/lists/watched'])">
        <span class="stat-value">{{ profileData.user.stats.moviesWatched }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">movie</span>
          <span>{{ 'profile.watched' | translate }}</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-value" style="font-size: 1.5rem;">{{ formatRuntime(profileData.user.stats.totalRuntime)
          }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">schedule</span>
          <span>{{ 'profile.watchedTime' | translate }}</span>
        </div>
      </div>
      <div class="stat-card">
        <span class="stat-value">{{ profileData.reviewCount }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">rate_review</span>
          <span>{{ 'profile.reviews' | translate }}</span>
        </div>
      </div>
      <div class="stat-card stat-card--clickable" (click)="openFollowers()">
        <span class="stat-value">{{ formatNumber(profileData.user.followersCount) }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">group</span>
          <span>{{ 'profile.followers' | translate }}</span>
        </div>
      </div>
      <div class="stat-card stat-card--clickable" (click)="openFollowing()">
        <span class="stat-value">{{ profileData.user.followingCount }}</span>
        <div class="stat-label">
          <span class="material-symbols-outlined">person_add</span>
          <span>{{ 'profile.following' | translate }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <div class="tabs-container">
      <button class="tab-item" [class.active]="activeTab() === 'profile'" (click)="onTabChange('profile')"
        type="button">
        <span>{{ 'profile.profile' | translate }}</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'lists'" (click)="onTabChange('lists')" type="button">
        <span>{{ 'profile.listsTab' | translate }}</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'reviews'" (click)="onTabChange('reviews')"
        type="button">
        <span>{{ 'profile.reviewsTab' | translate }}</span>
      </button>
      <button class="tab-item" [class.active]="activeTab() === 'likes'" (click)="onTabChange('likes')" type="button">
        <span>{{ 'profile.likesTab' | translate }}</span>
      </button>
    </div>
  </div>

  <!-- Content Section -->

  <div class="content-container">
    <div class="content-section">
      @if (activeTab() === 'profile') {
      <!-- Mood Charts Section -->
      @if (isOwnProfile()) {
      <div class="mood-section">
        <div class="mood-charts-grid">
          <app-mood-chart [moodData]="moodData()" [isLoading]="isLoadingMood()"></app-mood-chart>
          <app-mood-timeline [timelineData]="moodTimeline()" [isLoading]="isLoadingTimeline()"></app-mood-timeline>
        </div>
      </div>

      <!-- Badges Section -->
      <div class="badges-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">workspace_premium</span>
            {{ 'profile.moodBadges' | translate }}
          </h2>
        </div>
        @if (isLoadingBadges()) {
        <div class="badges-loading">
          <div class="spinner"></div>
        </div>
        } @else if (badges().length > 0) {
        <div class="badges-slider-container">
          <button class="slider-btn prev" (click)="scrollBadges('left')">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>

          <div class="badges-slider" #badgesContainer>
            @for (badge of badges(); track badge.id) {
            <div class="badge-item" [class.earned]="badge.earnedAt" [title]="badge.description">
              <span class="badge-icon">{{ badge.icon }}</span>
              @if (!badge.earnedAt && badge.progress !== undefined && badge.threshold) {
              <div class="badge-progress">
                <div class="badge-progress-bar" [style.width.%]="(badge.progress / badge.threshold) * 100"></div>
              </div>
              <span class="badge-progress-text">{{ badge.progress }}/{{ badge.threshold }}</span>
              }
              <span class="badge-name">{{ badge.name }}</span>
            </div>
            }
          </div>

          <button class="slider-btn next" (click)="scrollBadges('right')">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>
        } @else {
        <div class="badges-empty">
          <p>{{ 'profile.earnBadgesHint' | translate }}</p>
        </div>
        }
      </div>

      <!-- Mood Recommendations Section -->
      <div class="badges-section recommendations-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">movie_filter</span>
            {{ 'profile.forYourMood' | translate }}
          </h2>

          <!-- Controls -->
          <div class="mood-controls">
            <button class="mood-toggle-btn" (click)="toggleMoodRecsMode()">
              <span class="material-symbols-outlined">{{ moodRecsMode() === 'match' ? 'favorite' : 'swap_horiz'
                }}</span>
              {{ (moodRecsMode() === 'match' ? 'profile.match' : 'profile.shift') | translate }}
            </button>
            <button class="mood-toggle-btn" [class.active]="includeWatched()" (click)="toggleIncludeWatched()">
              <span class="material-symbols-outlined">{{ includeWatched() ? 'visibility' : 'visibility_off' }}</span>
              {{ (includeWatched() ? 'profile.all' : 'profile.unwatched') | translate }}
            </button>
          </div>
        </div>
        @if (isLoadingRecommendations()) {
        <div class="badges-loading">
          <div class="spinner"></div>
        </div>
        } @else if (moodRecommendations().length > 0) {
        <div class="badges-slider-container">
          <button class="slider-btn prev" (click)="scrollRecommendations('left')">
            <span class="material-symbols-outlined">chevron_left</span>
          </button>

          <div class="badges-slider" #recommendationsContainer>
            @for (rec of moodRecommendations(); track rec.tmdbId) {
            <div class="recommendation-card" (click)="router.navigate(['/movies', rec.tmdbId])">
              <img [src]="tmdbService.getPosterUrl(rec.posterPath, 'w300')" [alt]="rec.title" class="rec-poster" />
              <div class="rec-overlay">
                <span class="material-symbols-outlined">play_circle</span>
              </div>
              <div class="rec-score" [title]="'Match Score: ' + rec.score + '%'">
                {{ rec.score }}%
              </div>
            </div>
            }
          </div>

          <button class="slider-btn next" (click)="scrollRecommendations('right')">
            <span class="material-symbols-outlined">chevron_right</span>
          </button>
        </div>
        } @else {
        <div class="badges-empty">
          <p>{{ 'profile.noMoodRecs' | translate }}</p>
        </div>
        }
      </div>
      }
      <!-- Director's Cut (Movies) Section -->
      @if (profileData.user.favoriteMovies.length > 0) {
      <div class="favorites-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">movie</span>
            {{ 'profile.directorsMovieCut' | translate }}
          </h2>
          @if (isOwnProfile()) {
          <button class="section-edit-btn" (click)="openEditFavorites('movies')">
            <span class="material-symbols-outlined">edit</span>
            {{ 'profile.edit' | translate }}
          </button>
          }
        </div>
        <div class="favorites-grid">
          @for (movie of profileData.user.favoriteMovies; track movie.tmdbId) {
          <div class="favorite-item" (click)="router.navigate(['/movies', movie.tmdbId])">
            <img [src]="tmdbService.getPosterUrl(movie.posterPath, 'w300')" [alt]="movie.title"
              class="favorite-poster" />
            <div class="favorite-overlay">
              <span class="material-symbols-outlined">visibility</span>
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- Director's Cut (TV Shows) Section -->
      @if (profileData.user.favoriteTvShows.length > 0) {
      <div class="favorites-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">tv</span>
            {{ 'profile.directorsTvCut' | translate }}
          </h2>
          @if (isOwnProfile()) {
          <button class="section-edit-btn" (click)="openEditFavorites('tv')">
            <span class="material-symbols-outlined">edit</span>
            {{ 'profile.edit' | translate }}
          </button>
          }
        </div>
        <div class="favorites-grid">
          @for (show of profileData.user.favoriteTvShows; track show.tmdbId) {
          <div class="favorite-item" (click)="router.navigate(['/tv', show.tmdbId])">
            <img [src]="tmdbService.getPosterUrl(show.posterPath, 'w300')" [alt]="show.name" class="favorite-poster" />
            <div class="favorite-overlay">
              <span class="material-symbols-outlined">visibility</span>
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- Recent Activity Section -->
      @if (profileData.recentActivities.length > 0) {
      <div class="activity-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="material-symbols-outlined section-icon">history</span>
            {{ 'profile.recentActivity' | translate }}
          </h2>
          <a class="section-view-all" href="#">
            {{ 'profile.viewAll' | translate }}
            <span class="material-symbols-outlined">arrow_forward</span>
          </a>
        </div>
        <div class="activity-carousel">
          @for (activity of profileData.recentActivities; track activity._id) {
          <div class="activity-card">
            <div class="activity-image">
              <img [src]="tmdbService.getPosterUrl(activity.mediaPosterPath, 'w500')" [alt]="activity.mediaTitle" />
              @if (activity.rating) {
              <div class="activity-rating-badge">
                <span class="material-symbols-outlined">star</span>
                <span>{{ activity.rating.toFixed(1) }}</span>
              </div>
              }
            </div>
            <div class="activity-info">
              <h3 class="activity-title">{{ activity.mediaTitle }}</h3>
              <div class="activity-meta">
                <span class="activity-time">{{ getTimeAgo(activity.createdAt) }}</span>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }
      } @else if (activeTab() === 'lists') {
      <!-- Lists Tab Content -->
      <div class="lists-tab-content">
        <!-- View Toggle -->
        <div class="lists-view-toggle">
          <button class="view-toggle-btn" [class.active]="listsViewMode() === 'slider'"
            (click)="listsViewMode.set('slider')">
            <span class="material-symbols-outlined">view_carousel</span>
            <span>{{ 'profile.sliderView' | translate }}</span>
          </button>
          <button class="view-toggle-btn" [class.active]="listsViewMode() === 'list'"
            (click)="listsViewMode.set('list')">
            <span class="material-symbols-outlined">list</span>
            <span>{{ 'profile.listView' | translate }}</span>
          </button>
        </div>

        @if (listsViewMode() === 'slider') {
        <!-- Watched List Section -->
        @if (watched(); as watchedList) {
        <div class="list-card">
          <div class="list-card-header">
            <div class="list-card-title">
              <span class="material-symbols-outlined list-icon">visibility</span>
              <h3>{{ 'watched.title' | translate }}</h3>
              <span class="list-badge">{{ watchedList.items.length }}</span>
            </div>
            <div class="list-card-actions">
              @if (isOwnProfile()) {
              <div class="privacy-dropdown-container">
                <button class="privacy-btn" (click)="togglePrivacyDropdown('watched', $event)">
                  <span class="material-symbols-outlined">{{ getPrivacyIcon(watchedList.privacyStatus) }}</span>
                </button>
                @if (activePrivacyDropdown() === 'watched') {
                <div class="privacy-dropdown" (click)="$event.stopPropagation()">
                  <button class="privacy-option" [class.active]="watchedList.privacyStatus === 0"
                    (click)="updateWatchedPrivacy(0)">
                    <span class="material-symbols-outlined">public</span>
                    <span>{{ 'privacy.everyone' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchedList.privacyStatus === 1"
                    (click)="updateWatchedPrivacy(1)">
                    <span class="material-symbols-outlined">group</span>
                    <span>{{ 'privacy.friends' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchedList.privacyStatus === 2"
                    (click)="updateWatchedPrivacy(2)">
                    <span class="material-symbols-outlined">lock</span>
                    <span>{{ 'privacy.nobody' | translate }}</span>
                  </button>
                </div>
                }
              </div>
              }
              <button class="expand-btn" routerLink="/lists/watched">
                <span>{{ 'profile.viewAll' | translate }}</span>
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>
          </div>

          @if (watchedList.items.length > 0) {
          <div class="list-slider-container">
            <button class="slider-btn prev" (click)="scrollWatched('left')">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>

            <div class="list-slider" #watchedContainer>
              @for (item of watchedList.items.slice(0, 20); track item.tmdbId) {
              <div class="list-poster-card"
                (click)="router.navigate([item.mediaType === 'tv' ? '/tv' : '/movies', item.tmdbId])">
                @if (item.posterPath) {
                <img [src]="tmdbService.getPosterUrl(item.posterPath, 'w300')" [alt]="item.title" class="poster-img" />
                } @else {
                <div class="poster-placeholder">
                  <span class="material-symbols-outlined">movie</span>
                </div>
                }
                <div class="poster-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </div>
                @if (item.rating) {
                <div class="poster-rating">
                  <span class="material-symbols-outlined">star</span>
                  {{ item.rating.toFixed(1) }}
                </div>
                }
              </div>
              }
            </div>

            <button class="slider-btn next" (click)="scrollWatched('right')">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          } @else {
          <div class="list-empty">
            <span class="material-symbols-outlined">movie</span>
            <p>{{ 'watched.empty' | translate }}</p>
          </div>
          }
        </div>
        }

        <!-- Default Watchlist Section -->
        @if (defaultWatchlist(); as watchlist) {
        <div class="list-card">
          <div class="list-card-header">
            <div class="list-card-title">
              <span class="material-symbols-outlined list-icon">bookmark</span>
              <h3>{{ 'watchlist.title' | translate }}</h3>
              <span class="list-badge">{{ watchlist.items.length }}</span>
            </div>
            <div class="list-card-actions">
              @if (isOwnProfile()) {
              <div class="privacy-dropdown-container">
                <button class="privacy-btn" (click)="togglePrivacyDropdown('watchlist', $event)">
                  <span class="material-symbols-outlined">{{ getPrivacyIcon(watchlist.privacyStatus) }}</span>
                </button>
                @if (activePrivacyDropdown() === 'watchlist') {
                <div class="privacy-dropdown" (click)="$event.stopPropagation()">
                  <button class="privacy-option" [class.active]="watchlist.privacyStatus === 0"
                    (click)="updateWatchlistPrivacy(watchlist._id, 0)">
                    <span class="material-symbols-outlined">public</span>
                    <span>{{ 'privacy.everyone' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchlist.privacyStatus === 1"
                    (click)="updateWatchlistPrivacy(watchlist._id, 1)">
                    <span class="material-symbols-outlined">group</span>
                    <span>{{ 'privacy.friends' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="watchlist.privacyStatus === 2"
                    (click)="updateWatchlistPrivacy(watchlist._id, 2)">
                    <span class="material-symbols-outlined">lock</span>
                    <span>{{ 'privacy.nobody' | translate }}</span>
                  </button>
                </div>
                }
              </div>
              }
              <button class="expand-btn" routerLink="/lists/watchlist">
                <span>{{ 'profile.viewAll' | translate }}</span>
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>
          </div>

          @if (watchlist.items.length > 0) {
          <div class="list-slider-container">
            <button class="slider-btn prev" (click)="scrollWatchlist('left')">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>

            <div class="list-slider" #watchlistContainer>
              @for (item of watchlist.items.slice(0, 20); track item.tmdbId) {
              <div class="list-poster-card"
                (click)="router.navigate([item.mediaType === 'tv' ? '/tv' : '/movies', item.tmdbId])">
                @if (item.posterPath) {
                <img [src]="tmdbService.getPosterUrl(item.posterPath, 'w300')" [alt]="item.title" class="poster-img" />
                } @else {
                <div class="poster-placeholder">
                  <span class="material-symbols-outlined">movie</span>
                </div>
                }
                <div class="poster-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </div>
              </div>
              }
            </div>

            <button class="slider-btn next" (click)="scrollWatchlist('right')">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          } @else {
          <div class="list-empty">
            <span class="material-symbols-outlined">bookmark_border</span>
            <p>{{ 'watchlist.empty' | translate }}</p>
          </div>
          }
        </div>
        }

        <!-- Custom Lists Section -->
        @for (list of customWatchlists(); track list._id) {
        <div class="list-card">
          <div class="list-card-header">
            <div class="list-card-title">
              <span class="material-symbols-outlined list-icon">{{ list.icon || 'list' }}</span>
              <h3>{{ list.name }}</h3>
              <span class="list-badge">{{ list.items.length }}</span>
            </div>
            <div class="list-card-actions">
              @if (isOwnProfile()) {
              <div class="privacy-dropdown-container">
                <button class="privacy-btn" (click)="togglePrivacyDropdown(list._id, $event)">
                  <span class="material-symbols-outlined">{{ getPrivacyIcon(list.privacyStatus) }}</span>
                </button>
                @if (activePrivacyDropdown() === list._id) {
                <div class="privacy-dropdown" (click)="$event.stopPropagation()">
                  <button class="privacy-option" [class.active]="list.privacyStatus === 0"
                    (click)="updateWatchlistPrivacy(list._id, 0)">
                    <span class="material-symbols-outlined">public</span>
                    <span>{{ 'privacy.everyone' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="list.privacyStatus === 1"
                    (click)="updateWatchlistPrivacy(list._id, 1)">
                    <span class="material-symbols-outlined">group</span>
                    <span>{{ 'privacy.friends' | translate }}</span>
                  </button>
                  <button class="privacy-option" [class.active]="list.privacyStatus === 2"
                    (click)="updateWatchlistPrivacy(list._id, 2)">
                    <span class="material-symbols-outlined">lock</span>
                    <span>{{ 'privacy.nobody' | translate }}</span>
                  </button>
                </div>
                }
              </div>
              }
              <button class="expand-btn" [routerLink]="['/lists', list._id]">
                <span>{{ 'profile.viewAll' | translate }}</span>
                <span class="material-symbols-outlined">arrow_forward</span>
              </button>
            </div>
          </div>

          @if (list.items.length > 0) {
          <div class="list-slider-container">
            <button class="slider-btn prev" (click)="scrollCustomList('list-' + list._id, 'left')">
              <span class="material-symbols-outlined">chevron_left</span>
            </button>

            <div class="list-slider" [id]="'list-' + list._id">
              @for (item of list.items.slice(0, 20); track item.tmdbId) {
              <div class="list-poster-card"
                (click)="router.navigate([item.mediaType === 'tv' ? '/tv' : '/movies', item.tmdbId])">
                @if (item.posterPath) {
                <img [src]="tmdbService.getPosterUrl(item.posterPath, 'w300')" [alt]="item.title" class="poster-img" />
                } @else {
                <div class="poster-placeholder">
                  <span class="material-symbols-outlined">movie</span>
                </div>
                }
                <div class="poster-overlay">
                  <span class="material-symbols-outlined">play_circle</span>
                </div>
              </div>
              }
            </div>

            <button class="slider-btn next" (click)="scrollCustomList('list-' + list._id, 'right')">
              <span class="material-symbols-outlined">chevron_right</span>
            </button>
          </div>
          } @else {
          <div class="list-empty">
            <span class="material-symbols-outlined">{{ list.icon || 'list' }}</span>
            <p>{{ 'watchlist.emptyList' | translate }}</p>
          </div>
          }
        </div>
        }
        } @else {
        <!-- Compact List View -->
        <div class="lists-compact-view">
          <!-- Watched List -->
          @if (watched(); as watchedList) {
          <a class="compact-list-item" routerLink="/lists/watched">
            <div class="compact-list-icon">
              <span class="material-symbols-outlined">visibility</span>
            </div>
            <div class="compact-list-info">
              <span class="compact-list-name">{{ 'watched.title' | translate }}</span>
              <span class="compact-list-count">{{ watchedList.items.length }} {{ 'watchlist.items' | translate }}</span>
            </div>
            <span class="material-symbols-outlined compact-list-arrow">chevron_right</span>
          </a>
          }

          <!-- Default Watchlist -->
          @if (defaultWatchlist(); as watchlist) {
          <a class="compact-list-item" routerLink="/lists/watchlist">
            <div class="compact-list-icon">
              <span class="material-symbols-outlined">bookmark</span>
            </div>
            <div class="compact-list-info">
              <span class="compact-list-name">{{ 'watchlist.title' | translate }}</span>
              <span class="compact-list-count">{{ watchlist.items.length }} {{ 'watchlist.items' | translate }}</span>
            </div>
            <span class="material-symbols-outlined compact-list-arrow">chevron_right</span>
          </a>
          }

          <!-- Custom Lists -->
          @for (list of customWatchlists(); track list._id) {
          <a class="compact-list-item" [routerLink]="['/lists', list._id]">
            <div class="compact-list-icon">
              <span class="material-symbols-outlined">{{ list.icon || 'list' }}</span>
            </div>
            <div class="compact-list-info">
              <span class="compact-list-name">{{ list.name }}</span>
              <span class="compact-list-count">{{ list.items.length }} {{ 'watchlist.items' | translate }}</span>
            </div>
            <span class="material-symbols-outlined compact-list-arrow">chevron_right</span>
          </a>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<!-- Followers/Following Dialog -->
@if (showUserListDialog()) {
<div class="user-list-dialog-backdrop" (click)="closeUserListDialog()">
  <div class="user-list-dialog" (click)="$event.stopPropagation()">
    <div class="user-list-dialog-header">
      <h3>{{ (userListType() === 'followers' ? 'profile.followers' : 'profile.following') | translate }}</h3>
      <button class="dialog-close" (click)="closeUserListDialog()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="user-list-dialog-body">
      @if (isUserListLoading()) {
      <div class="user-list-loading">
        <div class="spinner"></div>
      </div>
      } @else if (userList().length === 0) {
      <div class="user-list-empty">
        <span class="material-symbols-outlined">person_off</span>
        <p>{{ (userListType() === 'followers' ? 'profile.noFollowers' : 'profile.notFollowingAnyone') | translate }}</p>
      </div>
      } @else {
      <div class="user-list">
        @for (user of userList(); track user.id) {
        <div class="user-item">
          <div class="user-item-info" (click)="router.navigate(['/profile', user.username]); closeUserListDialog()">
            <div class="user-avatar">
              <span class="material-symbols-outlined">person</span>
            </div>
            <div class="user-info">
              <span class="user-nickname">{{ user.name || user.username }}</span>
              <span class="user-username">@{{ user.username }}</span>
            </div>
          </div>
          @if (isOwnProfile()) {
          <button class="user-action-btn"
            (click)="userListType() === 'followers' ? removeFromList(user.id) : unfollowFromList(user.id)">
            {{ (userListType() === 'followers' ? 'profile.remove' : 'profile.unfollow') | translate }}
          </button>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}

<!-- Edit Profile Dialog -->
@if (showEditProfileDialog()) {
<div class="user-list-dialog-backdrop" (click)="closeEditProfile()">
  <div class="user-list-dialog edit-profile-dialog" (click)="$event.stopPropagation()">
    <div class="user-list-dialog-header">
      <h3>{{ 'profile.editProfile' | translate }}</h3>
      <button class="dialog-close" (click)="closeEditProfile()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="edit-profile-body">
      <!-- Avatar Section -->
      <div class="form-group">
        <label>{{ 'profile.avatarUrl' | translate }}</label>
        <div class="avatar-input-wrapper">
          <div class="avatar-preview">
            @if (editAvatar()) {
            <img [src]="editAvatar()" alt="Avatar preview" onError="this.style.display='none'">
            } @else {
            <div class="avatar-placeholder">
              <span class="material-symbols-outlined">person</span>
            </div>
            }
          </div>
          <div class="avatar-upload-controls">
            <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" hidden>
            <button class="upload-btn" (click)="fileInput.click()" type="button">
              <span class="material-symbols-outlined">upload_file</span>
              {{ (selectedFile ? 'profile.changeImage' : 'profile.chooseImage') | translate }}
            </button>
            <p class="help-text">{{ 'profile.avatarHint' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Banner Section -->
      <div class="form-group">
        <label>{{ 'profile.bannerImage' | translate }}</label>
        <div class="banner-upload-wrapper">
          <input type="file" #bannerInput (change)="onBannerSelected($event)" accept="image/*" hidden>
          <div class="banner-preview clickable" (click)="bannerInput.click()">
            @if (editBanner()) {
            <img [src]="editBanner()" alt="Banner preview" class="banner-preview-img"
              onError="this.style.display='none'">
            <div class="banner-hover-overlay">
              <span class="material-symbols-outlined">edit</span>
              <span>{{ 'profile.changeBanner' | translate }}</span>
            </div>
            } @else {
            <div class="banner-placeholder">
              <span class="material-symbols-outlined">add_photo_alternate</span>
              <p>{{ 'profile.clickToSelectBanner' | translate }}</p>
            </div>
            }
          </div>
          <p class="help-text banner-help">{{ 'profile.bannerHint' | translate }}</p>
        </div>
      </div>

      <!-- Real Name Section -->
      <div class="form-group">
        <label>{{ 'profile.realName' | translate }}</label>
        <input type="text" [ngModel]="editName()" (ngModelChange)="editName.set($event)"
          [placeholder]="'profile.realNamePlaceholder' | translate" class="form-input" maxlength="100">
      </div>

      <!-- Username Section -->
      <div class="form-group">
        <label>{{ 'profile.username' | translate }}</label>
        <input type="text" [ngModel]="editUsername()" (ngModelChange)="editUsername.set($event)"
          [placeholder]="'profile.usernamePlaceholder' | translate" class="form-input" maxlength="30"
          [disabled]="!canChangeUsername()">
        @if (!canChangeUsername() && canChangeUsernameAt()) {
        <p class="username-restriction-text">
          <span class="material-symbols-outlined">schedule</span>
          {{ 'profile.usernameChangeRestricted' | translate:{ date: (canChangeUsernameAt() | date:'mediumDate') || '' }
          }}
        </p>
        }
      </div>

    </div>

    <div class="dialog-actions">
      <button class="cancel-btn" (click)="closeEditProfile()">{{ 'profile.cancel' | translate }}</button>
      <button class="save-btn" (click)="saveProfile()" [disabled]="isEditLoading()">
        @if (isEditLoading()) {
        <span class="spinner-small"></span>
        {{ 'profile.saving' | translate }}
        } @else {
        {{ 'profile.saveChanges' | translate }}
        }
      </button>
    </div>
  </div>
</div>

<!-- Mood Comparison Dialog -->
@if (showComparisonDialog()) {
<div class="dialog-overlay" (click)="closeComparisonDialog()">
  <div class="comparison-dialog" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2><span class="material-symbols-outlined">compare</span> {{ 'profile.moodComparison' | translate }}</h2>
      <button class="close-btn" (click)="closeComparisonDialog()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="dialog-body">
      @if (isLoadingComparison()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>{{ 'profile.comparingMoods' | translate }}</p>
      </div>
      } @else if (moodComparison()) {
      <div class="comparison-content">
        <div class="similarity-section">
          <div class="similarity-circle" [class.high]="moodComparison()!.similarity >= 75">
            <span class="similarity-value">{{ moodComparison()!.similarity }}%</span>
            <span class="similarity-label">{{ 'profile.match' | translate }}</span>
          </div>
          <p class="similarity-text">
            @if (moodComparison()!.similarity >= 80) { {{ 'profile.cinematicSoulmates' | translate }} }
            @else if (moodComparison()!.similarity >= 60) { {{ 'profile.similarVibes' | translate }} }
            @else if (moodComparison()!.similarity >= 40) { {{ 'profile.someOverlap' | translate }} }
            @else { {{ 'profile.differentPerspectives' | translate }} }
          </p>
        </div>
        <div class="dimension-comparison">
          <h3>{{ 'profile.dimensionBreakdown' | translate }}</h3>
          <div class="dimensions-list">
            @for (dim of moodComparison()!.dimensionComparison; track dim.dimension) {
            <div class="dimension-row">
              <span class="dim-label">{{ getDimensionLabel(dim.dimension) }}</span>
              <div class="dim-bars">
                <div class="bar-container you">
                  <div class="bar" [style.width.%]="dim.user1Value"></div><span class="bar-value">{{ dim.user1Value
                    }}</span>
                </div>
                <div class="bar-container them">
                  <div class="bar" [style.width.%]="dim.user2Value"></div><span class="bar-value">{{ dim.user2Value
                    }}</span>
                </div>
              </div>
            </div>
            }
          </div>
          <div class="legend">
            <span class="legend-item you"><span class="dot"></span> {{ 'profile.you' | translate }}</span>
            <span class="legend-item them"><span class="dot"></span> {{ profile()?.user?.name ||
              profile()?.user?.username }}</span>
          </div>
        </div>
        @if (moodComparison()!.commonStrengths.length > 0) {
        <div class="strengths-section">
          <h3>{{ 'profile.sharedStrengths' | translate }}</h3>
          <div class="strength-tags">
            @for (s of moodComparison()!.commonStrengths; track s) {
            <span class="strength-tag common">{{ getDimensionLabel(s) }}</span>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
}
}
}
<app-share-dialog [isOpen]="showShareDialog()" [profile]="profile()" [moodData]="moodData()" [badges]="badges()"
  [close]="closeShareDialog">
</app-share-dialog>

<!-- Edit Favorites Dialog -->
@if (showEditFavoritesDialog() && profile(); as p) {
<app-edit-favorites-dialog [isOpen]="showEditFavoritesDialog()" [initialMovies]="p.user.favoriteMovies"
  [initialTvShows]="p.user.favoriteTvShows" [initialTab]="editFavoritesTab()" (close)="closeEditFavoritesDialog()"
  (save)="saveFavorites($event)">
</app-edit-favorites-dialog>
}

<app-edit-list-dialog [isOpen]="showEditListDialog()" [listTitle]="selectedListForEdit()?.name || ''"
  [listIcon]="selectedListForEdit()?.icon || 'list'" [initialItems]="getEditListItems(selectedListForEdit())"
  [isDefault]="false" (close)="showEditListDialog.set(false)" (save)="saveCustomList($event)">
</app-edit-list-dialog>